<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù†ØªØ§Ø¬ â€” ÙƒØ§Ù…Ù„</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
  body{font-family: Tahoma, Arial; direction:rtl; background:#f6f8fb; margin:16px; color:#222}
  h1{text-align:center; color:#0b4f8a; margin-bottom:12px}
  .top-row{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-bottom:8px}
  .top-row label{display:flex;flex-direction:column;min-width:220px;font-size:13px}
  .top-row .field-inline{display:flex;gap:6px;align-items:center}
  .top-row input[type="text"], .top-row select{padding:6px;width:220px;box-sizing:border-box}

  .top-controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:12px}
  .top-controls .btn{padding:8px 12px;background:#0b6ed3;color:#fff;border-radius:6px;border:0;cursor:pointer}
  .top-controls .btn.secondary{background:#0b87ff}
  .top-controls select{padding:6px;width:220px;box-sizing:border-box}

  .materials-row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:8px}
  .material-input{width:220px;padding:6px;border-radius:4px;border:1px solid #ccc;box-sizing:border-box}
  .material-wrap{display:flex;gap:6px;align-items:center}

  table.stage{width:100%;border-collapse:collapse;margin:18px 0;background:#fff;box-shadow:0 0 0 1px #e6eef8}
  table.stage thead th{background:#0b6ed3;color:#fff;padding:8px;text-align:center}
  table.stage thead tr.sub-header th{background:#dbeeff;color:#000;font-weight:600}
  table.stage th, table.stage td{border:1px solid #c8d9ee;padding:6px;vertical-align:middle;text-align:center}
  select,input[type="text"],input[type="number"],input[type="datetime-local"],textarea{width:100%;padding:6px;box-sizing:border-box;font-size:13px}
  textarea{resize:none;min-height:40px}

  .btn-square{width:28px;height:28px;border-radius:4px;border:0;cursor:pointer;font-weight:bold;display:inline-flex;align-items:center;justify-content:center}
  .btn-add{background:#0b87ff;color:#fff}
  .btn-del{background:#e74c3c;color:#fff}

  /* row colors light */
  tr.status-done{background:#e6f7ea}
  tr.status-progress{background:#fffbe6}
  tr.status-error{background:#fdecea}

  /* tech select same width as client name */
  .tech-select{width:220px!important}

  @media (max-width:900px){
    .top-row label{min-width:150px;width:48%}
    .top-row input[type="text"], .top-row select{width:100%}
    table.stage td, table.stage th{font-size:12px;padding:4px}
    .top-controls select, .material-input { width:100%; }
  }

  .msg{font-size:13px;color:#0b6ed3;margin-left:8px}
  .save-btn{padding:10px 16px;background:#0b6ed3;color:#fff;border:0;border-radius:6px;cursor:pointer}

  .del-material{background:#e74c3c;color:#fff;border:0;border-radius:4px;padding:6px 8px;cursor:pointer}
</style>
</head>
<body>
<h1>Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù†ØªØ§Ø¬</h1>

<div class="top-row">
  <label>ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„
    <div class="field-inline">
      <input type="text" id="clientCode" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ù…ÙØªØ§Ø­)"/>
      <button type="button" id="btnSearch" class="btn-square btn-add" title="Ø¨Ø­Ø«">ğŸ”</button>
    </div>
  </label>

  <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„
    <input type="text" id="clientName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„"/>
  </label>

  <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
    <input type="text" id="projectName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"/>
  </label>

   <label>Ø£Ø¶Ù ÙÙ†ÙŠ Ø¬Ø¯ÙŠØ¯
    <div style="display:flex;gap:6px">
      <input type="text" id="newTech" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ÙÙ†ÙŠ"/>
      <button type="button" id="btnAddTech" class="btn-square btn-add" title="Ø£Ø¶Ù ÙÙ†ÙŠ">+</button>
    </div>
  </label>

  <div style="display:flex;align-items:center">
    <span id="recallMsg" class="msg" style="display:none"></span>
  </div>
</div>

<div class="top-controls" aria-label="controls">
  <button id="btnSave" class="btn">Ø­ÙØ¸</button>
  <button id="btnExportJSON" class="btn secondary">ØªØµØ¯ÙŠØ± JSON</button>
  <button id="btnExportPDF" class="btn secondary">ØªØµØ¯ÙŠØ± PDF</button>

  <input id="internalMaterial" class="material-input" placeholder="Ø§Ù„Ø®Ø§Ù…Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©" title="Ø§Ù„Ø®Ø§Ù…Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© (Ù†ÙØ³ Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„)"/>
  <input id="externalMaterial" class="material-input" placeholder="Ø§Ù„Ø®Ø§Ù…Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©" title="Ø§Ù„Ø®Ø§Ù…Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© (Ù†ÙØ³ Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„)"/>
  <button id="btnAddMaterial" class="btn">+</button>
</div>

<div id="extraMaterialsContainer" class="materials-row"></div>

<form id="prodForm">
  <template id="tpl-basic-row">
    <tr class="data-row">
      <td>
        <div style="display:flex;align-items:center;gap:6px;justify-content:flex-end">
          <select class="item-type">
            <option value="">Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø¯</option>
            <option>Ù‡ÙŠÙƒÙ„</option>
            <option>HPL</option>
            <option>Ø¶Ù„ÙØ©</option>
          </select>
          <button type="button" class="btn-square btn-add btn-add-inline" title="Ø£Ø¶Ù ØµÙ">+</button>
        </div>
      </td>

      <td>
        <div style="display:flex;gap:6px;align-items:center;justify-content:flex-end">
          <input type="text" class="item-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ø¯"/>
          <button type="button" class="btn-square btn-del btn-del-inline" title="Ø­Ø°Ù ØµÙ">-</button>
        </div>
      </td>

      <td><select class="tech-list"></select></td>
      <td><input type="datetime-local" class="start-date"/></td>
      <td><input type="datetime-local" class="end-date"/></td>
      <td><input type="text" class="duration" readonly placeholder="Ø³Ø§Ø¹Ø§Øª"/></td>

      <td colspan="2"><textarea class="notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª..."></textarea></td>

      <td>
        <select class="status-select">
          <option value="">---</option>
          <option value="done">ØªÙ…</option>
          <option value="progress">ØªØ­Øª Ø§Ù„ØªØ´ØºÙŠÙ„</option>
          <option value="error">Ù…ØªØ¹Ø·Ù„ / Ù†Ù‚Øµ Ø®Ø§Ù…Ø©</option>
        </select>
      </td>
    </tr>
  </template>

  <template id="tpl-advanced-row">
    <tr class="data-row">
      <td>
        <div style="display:flex;align-items:center;gap:6px;justify-content:flex-end">
          <select class="item-type">
            <option value="">Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø¯</option>
            <option>Ù‡ÙŠÙƒÙ„</option>
            <option>HPL</option>
            <option>Ø¶Ù„ÙØ©</option>
          </select>
          <button type="button" class="btn-square btn-add btn-add-inline" title="Ø£Ø¶Ù ØµÙ">+</button>
        </div>
      </td>

      <td>
        <div style="display:flex;gap:6px;align-items:center;justify-content:flex-end">
          <input type="text" class="item-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ø¯"/>
          <button type="button" class="btn-square btn-del btn-del-inline" title="Ø­Ø°Ù ØµÙ">-</button>
        </div>
      </td>

      <td><select class="tech-list"></select></td>
      <td><input type="datetime-local" class="start-date"/></td>
      <td><input type="datetime-local" class="end-date"/></td>
      <td><input type="text" class="duration" readonly placeholder="Ø³Ø§Ø¹Ø§Øª"/></td>
      <td><input type="number" class="units" min="0" placeholder="Ø¹Ø¯Ø¯"/></td>
      <td><textarea class="notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª..."></textarea></td>
      <td>
        <select class="status-select">
          <option value="">---</option>
          <option value="done">ØªÙ…</option>
          <option value="progress">ØªØ­Øª Ø§Ù„ØªØ´ØºÙŠÙ„</option>
          <option value="error">Ù…ØªØ¹Ø·Ù„ / Ù†Ù‚Øµ Ø®Ø§Ù…Ø©</option>
        </select>
      </td>
    </tr>
  </template>

  <div id="stagesContainer"></div>

</form>

<script>
/* ======= Configuration (unchanged order) ======= */
const STAGES = [
  { id: "Ø§Ù„ØªÙ‚Ø·ÙŠØ¹", basic: true },
  { id: "Ø§Ù„Ù…ÙØ­Ø§Ø±", basic: true },
  { id: "Ø§Ù„Ù‚Ø´Ø§Ø·/Ø§Ù„Ø´Ø±ÙŠØ·", basic: true },
  { id: "Ø§Ù„Ù…ÙƒØ¨Ø³", basic: false },
  { id: "Ø§Ù„Ù…Ø±Ø­Ù„ÙŠØ© 1", basic: false },
  { id: "CNC", basic: false },
  { id: "Ø§Ù„Ù…Ø±Ø­Ù„ÙŠÙ‡ 2", basic: false },
  { id: "Ø§Ù„ØªØ¬Ù…ÙŠØ¹", basic: false },
  { id: "Ø§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©", basic: false }
];

/* technicians list persisted (unchanged) */
let technicians = JSON.parse(localStorage.getItem('motabaa_techs') || '["Ù…Ø­Ù…ÙˆØ¯","ÙŠÙˆØ³Ù","Ø¹Ø¨Ø¯ Ø§Ù„Ø³ØªØ§Ø±","Ù…Ø­Ù…Ø¯ Ø±Ø¨ÙŠØ¹"]');

const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyXZ_CLZ_MY-9eWeD7VSbSOI7qv9tN9IQVkqwjmrPi47wFAYVLiYZWGhyd1x9rcC20wpA/exec'; // **ØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø·**

/* ===== helpers ===== */
function byId(id){ return document.getElementById(id); }
function create(tag, html){ const e = document.createElement(tag); if(html) e.innerHTML = html; return e; }

/* ===== render stage tables (unchanged) ===== */
function renderStageTables(){
  const container = byId('stagesContainer');
  container.innerHTML = '';
  STAGES.forEach(stage=>{
    const tbl = create('table');
    tbl.className = 'stage';
    tbl.id = 'stage-' + stage.id.replace(/\s+/g,'-').replace(/[^\w\-Ø¡-ÙŠ]/g,'');
    const title = `
      <thead>
        <tr><th colspan="${ stage.basic ? 9 : 9 }">${stage.id}</th></tr>
        <tr>
          <th>Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø¯</th>
          <th>Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ø¯</th>
          <th>Ø§Ø³Ù… Ø§Ù„ÙÙ†ÙŠ</th>
          <th>Ø¨Ø¯Ø¡</th>
          <th>Ø§Ù†ØªÙ‡Ø§Ø¡</th>
          <th>Ù…Ø¯Ø© ØªØ´ØºÙŠÙ„</th>
          ${ stage.basic ? '<th colspan="2">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>' : '<th>Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>' }
          <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
        </tr>
      </thead>
      <tbody></tbody>
    `;
    tbl.innerHTML = title;
    container.appendChild(tbl);
  });
}

/* Append empty row (unchanged) */
function appendEmptyRowTo(stageId){
  const stage = STAGES.find(s => ('stage-' + s.id.replace(/\s+/g,'-').replace(/[^\w\-Ø¡-ÙŠ]/g,'')) === stageId || s.id === stageId);
  if(!stage) return;
  const tpl = document.getElementById(stage.basic ? 'tpl-basic-row' : 'tpl-advanced-row');
  const clone = tpl.content.cloneNode(true);
  const tr = clone.querySelector('tr');
  tr.dataset.stage = stage.id;
  const tbody = document.querySelector('#' + (stageId.startsWith('stage-') ? stageId : 'stage-' + stage.id.replace(/\s+/g,'-').replace(/[^\w\-Ø¡-ÙŠ]/g,'')) + ' tbody');
  tbody.appendChild(tr);
  setupRow(tr);
}

/* setup row listeners (unchanged) */
function setupRow(tr){
  if(!tr) return;
  // populate tech select
  const techSel = tr.querySelector('.tech-list');
  if(techSel) populateSingleTechSelect(techSel);

  // add button (inline)
  const addBtn = tr.querySelector('.btn-add-inline');
  if(addBtn) addBtn.onclick = ()=> addRowAfter(tr);

  // delete button
  const delBtn = tr.querySelector('.btn-del-inline');
  if(delBtn) delBtn.onclick = ()=> {
    const tbody = tr.parentNode;
    tr.remove();
    if(tbody.querySelectorAll('tr').length === 0){
      appendEmptyRowTo(tbody.parentNode.id);
    }
  };

  // start/end change -> duration
  const start = tr.querySelector('.start-date');
  const end = tr.querySelector('.end-date');
  [start,end].forEach(inp => { if(inp) inp.onchange = ()=> calculateDurationForRow(tr); });

  // status -> color
  const statusSel = tr.querySelector('.status-select');
  if(statusSel) statusSel.onchange = ()=> updateRowColor(tr);
}

/* populate single tech select element (unchanged) */
function populateSingleTechSelect(sel){
  const cur = sel.value || "";
  sel.innerHTML = '<option value="">-- Ø§Ø®ØªØ± ÙÙ†ÙŠ --</option>';
  technicians.forEach(t => {
    const o = document.createElement('option'); o.value = t; o.textContent = t; sel.appendChild(o);
  });
  if(cur) sel.value = cur;
}

/* populate all tech selects incl top mainTech (unchanged) */
function populateTechSelects(){
  document.querySelectorAll('.tech-list, #mainTech').forEach(sel => {
    const cur = sel.value || "";
    sel.innerHTML = '<option value="">-- Ø§Ø®ØªØ± ÙÙ†ÙŠ --</option>';
    technicians.forEach(t => { const o=document.createElement('option'); o.value=t; o.textContent=t; sel.appendChild(o); });
    if(cur) sel.value = cur;
  });
  // persist techs
  localStorage.setItem('motabaa_techs', JSON.stringify(technicians));
}

/* add row after current tr (unchanged) */
function addRowAfter(tr){
  const stageId = tr.closest('table').id;
  const stage = STAGES.find(s => 'stage-' + s.id.replace(/\s+/g,'-').replace(/[^\w\-Ø¡-ÙŠ]/g,'') === stageId);
  const tpl = document.getElementById(stage.basic ? 'tpl-basic-row' : 'tpl-advanced-row');
  const clone = tpl.content.cloneNode(true);
  const newTr = clone.querySelector('tr');
  newTr.dataset.stage = stage.id;
  tr.parentNode.insertBefore(newTr, tr.nextSibling);
  setupRow(newTr);
}

/* duration calc (unchanged) */
function calculateDurationForRow(tr){
  const s = tr.querySelector('.start-date')?.value;
  const e = tr.querySelector('.end-date')?.value;
  const durEl = tr.querySelector('.duration');
  if(s && e){
    const sd = new Date(s), ed = new Date(e);
    if(!isNaN(sd) && !isNaN(ed) && ed > sd){
      const hours = (ed - sd) / 36e5;
      if(durEl) durEl.value = hours.toFixed(2);
      tr.dataset.duration = hours.toFixed(2);
    } else {
      if(durEl) durEl.value = "";
      tr.dataset.duration = "";
    }
  } else {
    if(durEl) durEl.value = "";
    tr.dataset.duration = "";
  }
  updateRowColor(tr);
}

/* isRowEmpty (slightly adjusted as in your version) */
function isRowEmpty(tr){
  const name = (tr.querySelector('.item-name')?.value || "").trim();
  return name === "";
}

/* update row color (unchanged) */
function updateRowColor(tr){
  tr.classList.remove('status-done','status-progress','status-error');
  if(isRowEmpty(tr)) return;
  const val = tr.querySelector('.status-select')?.value || "";
  if(!val) return;
  if(val === 'done') tr.classList.add('status-done');
  else if(val === 'progress') tr.classList.add('status-progress');
  else if(val === 'error') tr.classList.add('status-error');
}

/* collectAllData: returns stages map (kept same) */
function collectAllData(){
  const out = {};
  STAGES.forEach(stage=>{
    const id = stage.id;
    out[id] = [];
    const tableId = 'stage-' + stage.id.replace(/\s+/g,'-').replace(/[^\w\-Ø¡-ÙŠ]/g,'');
    document.querySelectorAll('#' + tableId + ' tbody tr').forEach(tr=>{
      if(isRowEmpty(tr)) return;
      out[id].push({
        type: tr.querySelector('.item-type')?.value || "",
        itemName: tr.querySelector('.item-name')?.value || "",
        tech: tr.querySelector('.tech-list')?.value || "",
        start: tr.querySelector('.start-date')?.value || "",
        end: tr.querySelector('.end-date')?.value || "",
        duration: tr.dataset.duration || "",
        units: tr.querySelector('.units') ? tr.querySelector('.units').value : "",
        notes: tr.querySelector('.notes')?.value || "",
        status: tr.querySelector('.status-select')?.value || ""
      });
    });
  });
  return out;
}

/* --------- NEW: materials helpers --------- */
function addExtraMaterial(value){
  const wrap = document.createElement('div');
  wrap.className = 'material-wrap';
  const inp = document.createElement('input');
  inp.type = 'text';
  inp.className = 'extra-material';
  inp.placeholder = 'Ø®Ø§Ù…Ø© Ø¥Ø¶Ø§ÙÙŠØ©';
  inp.value = value || '';
  inp.style.width = '220px';
  inp.style.padding = '6px';
  inp.style.boxSizing = 'border-box';

  const del = document.createElement('button');
  del.type = 'button';
  del.className = 'del-material';
  del.textContent = 'âŒ';
  del.onclick = (e) => { e.preventDefault(); wrap.remove(); };

  wrap.appendChild(inp);
  wrap.appendChild(del);
  byId('extraMaterialsContainer').appendChild(wrap);
}

/* Export JSON (includes materials + stages + top fields) */
function exportJSON(){
  const clientCode = byId('clientCode').value.trim();
  const payload = {
    clientCode,
    clientName: byId('clientName').value.trim(),
    projectName: byId('projectName').value.trim(),
    internalMaterial: byId('internalMaterial').value || '',
    externalMaterial: byId('externalMaterial').value || '',
    extraMaterials: Array.from(document.querySelectorAll('.extra-material')).map(i=>i.value),
    technicians,
    stages: collectAllData(),
    savedAt: new Date().toISOString()
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type: 'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = (clientCode || 'export') + '.json';
  a.click();
  URL.revokeObjectURL(a.href);
}

/* Export PDF using jsPDF + autoTable */
function exportPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:'l', unit:'pt', format:'a4'});
  let y = 30;
  doc.setFontSize(14);
  doc.text('Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù†ØªØ§Ø¬', 40, y);
  y += 20;
  doc.setFontSize(11);
  doc.text('ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„: ' + (byId('clientCode').value || ''), 40, y); y += 16;
  doc.text('Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„: ' + (byId('clientName').value || ''), 40, y); y += 16;
  doc.text('Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹: ' + (byId('projectName').value || ''), 40, y); y += 16;
  doc.text('Ø§Ù„Ø®Ø§Ù…Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©: ' + (byId('internalMaterial').value || ''), 40, y); y += 16;
  doc.text('Ø§Ù„Ø®Ø§Ù…Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©: ' + (byId('externalMaterial').value || ''), 40, y); y += 16;
  const extras = Array.from(document.querySelectorAll('.extra-material')).map(i=>i.value).filter(Boolean);
  extras.forEach((m,i)=>{ doc.text('Ø®Ø§Ù…Ø© Ø¥Ø¶Ø§ÙÙŠØ© ' + (i+1) + ': ' + m, 40, y); y += 14; });

  // for each stage use autoTable
  STAGES.forEach(stage=>{
    const tableId = 'stage-' + stage.id.replace(/\s+/g,'-').replace(/[^\w\-Ø¡-ÙŠ]/g,'');
    const rows = [];
    document.querySelectorAll('#' + tableId + ' tbody tr').forEach(tr=>{
      if(isRowEmpty(tr)) return;
      const row = [
        tr.querySelector('.item-type')?.value || "",
        tr.querySelector('.item-name')?.value || "",
        tr.querySelector('.tech-list')?.value || "",
        tr.querySelector('.start-date')?.value || "",
        tr.querySelector('.end-date')?.value || "",
        tr.dataset.duration || ""
      ];
      if(stage.basic){
        row.push(tr.querySelector('.notes')?.value || "");
      } else {
        row.push(tr.querySelector('.units')?.value || "", tr.querySelector('.notes')?.value || "");
      }
      row.push(tr.querySelector('.status-select')?.value || "");
      rows.push(row);
    });
    if(rows.length){
      doc.setFontSize(12);
      doc.text(stage.id, 40, y); y += 14;
      const headers = stage.basic ? ['Ù†ÙˆØ¹','Ø§Ø³Ù…','ÙÙ†ÙŠ','Ø¨Ø¯Ø¡','Ø§Ù†ØªÙ‡Ø§Ø¡','Ù…Ø¯Ø©','Ù…Ù„Ø§Ø­Ø¸Ø§Øª','Ø§Ù„Ø­Ø§Ù„Ø©'] : ['Ù†ÙˆØ¹','Ø§Ø³Ù…','ÙÙ†ÙŠ','Ø¨Ø¯Ø¡','Ø§Ù†ØªÙ‡Ø§Ø¡','Ù…Ø¯Ø©','Ø¹Ø¯Ø¯','Ù…Ù„Ø§Ø­Ø¸Ø§Øª','Ø§Ù„Ø­Ø§Ù„Ø©'];
      doc.autoTable({ head:[headers], body: rows, startY: y, styles:{fontSize:9}, margin:{left:40,right:40} });
      y = doc.lastAutoTable.finalY + 12;
    }
  });

  doc.save((byId('clientCode').value.trim() || 'export') + '.pdf');
}

/* Save (to Google Apps Script) - local storage removed */
function saveAll(){
  const clientCode = byId('clientCode').value.trim();
  if(!clientCode){ alert('Ù…Ø·Ù„ÙˆØ¨: Ø§ÙƒØªØ¨ ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸'); return; }

  const payload = {
    clientCode,
    clientName: byId('clientName').value.trim(),
    projectName: byId('projectName').value.trim(),
    mainTech: byId('mainTech')?.value || '', // Check if element exists
    technicians,
    internalMaterial: byId('internalMaterial').value || '',
    externalMaterial: byId('externalMaterial').value || '',
    extraMaterials: Array.from(document.querySelectorAll('.extra-material')).map(i=>i.value),
    stages: collectAllData(),
    savedAt: new Date().toISOString()
  };

  const scriptURL = SCRIPT_URL;
  const msg = byId('recallMsg');
  msg.style.display = 'inline';
  msg.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';

  fetch(scriptURL, {
    method: 'POST',
    body: JSON.stringify(payload),
    headers: {
      'Content-Type': 'application/json'
    }
  })
  .then(response => response.json())
  .then(result => {
    if(result.success) {
      msg.textContent = 'ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ Ø¬ÙˆØ¬Ù„ Ø´ÙŠØª!';
    } else {
      msg.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸ Ø¥Ù„Ù‰ Ø¬ÙˆØ¬Ù„ Ø´ÙŠØª: ' + result.error;
    }
  })
  .catch(error => {
    console.error("Error saving data:", error);
    msg.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
  })
  .finally(() => {
    setTimeout(() => msg.style.display = 'none', 2200);
  });
}

/* New load from Google Sheets (instead of localStorage) */
function loadFromGoogleSheets(){
    const code = byId('clientCode').value.trim();
    if(!code){
        alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù„Ø¨Ø­Ø«.');
        return;
    }

    const recallMsg = byId('recallMsg');
    recallMsg.style.display = 'inline';
    recallMsg.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...';

    const scriptURL = SCRIPT_URL + '?clientCode=' + encodeURIComponent(code);

    fetch(scriptURL)
        .then(response => response.json())
        .then(result => {
            if(result.success && result.data){
                const payload = result.data;
                byId('clientName').value = payload.clientName || '';
                byId('projectName').value = payload.projectName || '';
                byId('internalMaterial').value = payload.internalMaterial || '';
                byId('externalMaterial').value = payload.externalMaterial || '';
                byId('extraMaterialsContainer').innerHTML = '';
                (payload.extraMaterials || []).forEach(m => addExtraMaterial(m));

                if(Array.isArray(payload.technicians) && payload.technicians.length){
                  technicians = payload.technicians;
                }
                populateTechSelects();

                STAGES.forEach(stage=>{
                  const tableId = 'stage-' + stage.id.replace(/\s+/g,'-').replace(/[^\w\-Ø¡-ÙŠ]/g,'');
                  const tbody = document.querySelector('#' + tableId + ' tbody');
                  tbody.innerHTML = '';
                  const rows = (payload.stages && payload.stages[stage.id]) || [];
                  if(rows.length === 0){
                    appendEmptyRowTo(tableId);
                  } else {
                    rows.forEach(r => {
                      const tpl = document.getElementById(stage.basic ? 'tpl-basic-row' : 'tpl-advanced-row');
                      const clone = tpl.content.cloneNode(true);
                      const tr = clone.querySelector('tr');
                      tr.dataset.stage = stage.id;
                      if(tr.querySelector('.item-type')) tr.querySelector('.item-type').value = r.type || "";
                      if(tr.querySelector('.item-name')) tr.querySelector('.item-name').value = r.itemName || "";
                      if(tr.querySelector('.tech-list')){
                        populateSingleTechSelect(tr.querySelector('.tech-list'));
                        tr.querySelector('.tech-list').value = r.tech || "";
                      }
                      if(tr.querySelector('.start-date')) tr.querySelector('.start-date').value = r.start || "";
                      if(tr.querySelector('.end-date')) tr.querySelector('.end-date').value = r.end || "";
                      if(r.duration) { tr.dataset.duration = r.duration; if(tr.querySelector('.duration')) tr.querySelector('.duration').value = r.duration; }
                      if(tr.querySelector('.units')) tr.querySelector('.units').value = r.units || "";
                      if(tr.querySelector('.notes')) tr.querySelector('.notes').value = r.notes || "";
                      if(tr.querySelector('.status-select')) tr.querySelector('.status-select').value = r.status || "";
                      tbody.appendChild(tr);
                      setupRow(tr);
                      updateRowColor(tr);
                    });
                  }
                });

                recallMsg.textContent = 'ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ Ù…Ù† Ø¬ÙˆØ¬Ù„ Ø´ÙŠØª!';
            } else {
                recallMsg.textContent = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ø¬ÙˆØ¬Ù„ Ø´ÙŠØª.';
            }
        })
        .catch(error => {
            console.error("Error fetching data:", error);
            recallMsg.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
        })
        .finally(() => {
            setTimeout(() => recallMsg.style.display = 'none', 2200);
        });
}

/* Add material button */
byId('btnAddMaterial').addEventListener('click', (e)=>{
  e.preventDefault();
  addExtraMaterial('');
});

/* Save button */
byId('btnSave').addEventListener('click', saveAll);

/* Search button */
byId('btnSearch').addEventListener('click', loadFromGoogleSheets);

/* Export buttons */
byId('btnExportJSON').addEventListener('click', exportJSON);
byId('btnExportPDF').addEventListener('click', exportPDF);

/* Add technician button */
byId('btnAddTech').addEventListener('click', ()=> {
  const v = byId('newTech').value.trim();
  if(!v) return alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ÙÙ†ÙŠ Ø«Ù… Ø§Ø¶ØºØ· +');
  if(!technicians.includes(v)) technicians.push(v);
  byId('newTech').value = '';
  populateTechSelects();
});

/* Initialize page */
async function init() {
  renderStageTables();
  STAGES.forEach(s => appendEmptyRowTo('stage-' + s.id.replace(/\s+/g, '-').replace(/[^Ø¡-ÙŠ\w\s-]/g, '')));

  try {
    const res = await fetch(SCRIPT_URL);
    const result = await res.json();
    if (result.success) {
      technicians = result.technicians;
      populateTechSelects();
    }
  } catch(error) {
    console.error("Error fetching technicians:", error);
  }
}
window.addEventListener('load', init);

</script>

</body>
</html>





















