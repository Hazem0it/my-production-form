<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>متابعة إنتاج — كامل</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
  body{font-family: Tahoma, Arial; direction:rtl; background:#f6f8fb; margin:16px; color:#222}
  h1{text-align:center; color:#0b4f8a; margin-bottom:12px}
  .top-row{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-bottom:8px}
  .top-row label{display:flex;flex-direction:column;min-width:220px;font-size:13px}
  .top-row .field-inline{display:flex;gap:6px;align-items:center}
  .top-row input[type="text"], .top-row select{padding:6px;width:220px;box-sizing:border-box}

  /* Tabs styling */
  .tab-buttons { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
  .tab-buttons button { padding: 10px 20px; border: 1px solid #ddd; background-color: #f1f1f1; cursor: pointer; border-radius: 5px; font-size: 16px; transition: background-color 0.3s; }
  .tab-buttons button:hover { background-color: #e9e9e9; }
  .tab-buttons button.active { background-color: #c0c0c0; }

  /* Stage table styling */
  .stage-table-container { display: none; }
  .stage-table-container.active { display: block; }
  .stage-table { width:100%; border-collapse:collapse; margin-top:20px; }
  .stage-table caption { font-size:1.2em; font-weight:bold; margin-bottom:10px; color:#0b4f8a; }
  .stage-table th, .stage-table td { padding:8px; border:1px solid #ddd; text-align:center; font-size:12px; }
  .stage-table th { background-color:#e6f2ff; font-size:13px; }
  .stage-table td { background-color:#fff; }
  .stage-table input, .stage-table select, .stage-table textarea { width:100%; box-sizing:border-box; padding:4px; border:1px solid #ccc; font-family: Tahoma, Arial; font-size:12px; }
  .add-row-btn { background:#0b4f8a; color:#fff; border:none; padding:5px 10px; margin:5px 0; cursor:pointer; border-radius:3px; }
  .add-row-btn:hover { background:#0a457a; }
  .remove-row-btn { background:red; color:white; border:none; padding:5px 10px; cursor:pointer; border-radius:3px; }
  .status-select.done { background-color: #e6f7ea; }
  .status-select.progress { background-color: #fffbe6; }
  .status-select.error { background-color: #fdecea; }
  .stage-table .status-select, .stage-table .notes, .stage-table .tech-list { min-width:100px; }
  .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.7); justify-content: center; align-items: center; }

  /* Saving animation */
  .loading-overlay.visible { display: flex; }
  .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  .extra-materials-container {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 10px;
  }
  .material-row {
    display: flex;
    gap: 10px;
    align-items: center;
  }
  .material-row label {
    display: block;
    min-width: 100px;
  }
  .material-row input {
    flex-grow: 1;
  }
  .remove-material-btn {
    background: red;
    color: white;
    border: none;
    padding: 5px 10px;
    cursor: pointer;
    border-radius: 3px;
  }
</style>
</head>
<body>
  <h1>نظام متابعة الإنتاج</h1>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
  </div>

  <div class="top-row">
    <label>
      كود العميل
      <div class="field-inline">
        <input type="text" id="clientCode" placeholder="أدخل كود العميل">
        <button id="btnSearch">بحث</button>
      </div>
    </label>
    <label>
      كود العميل المحفوظة
      <div class="field-inline">
        <select id="savedCodesDropdown">
          <option value="">-- اختر كود --</option>
        </select>
        <button id="btnLoad">تحميل</button>
      </div>
    </label>
    <label>
      اسم العميل
      <input type="text" id="clientName">
    </label>
    <label>
      اسم المشروع
      <input type="text" id="projectName">
    </label>
    <button id="btnSave">حفظ</button>
    <button id="btnExportPDF">تصدير PDF</button>
  </div>

  <h2 id="formTitle">متابعة الإنتاج</h2>

  <div class="tab-buttons" id="tabButtons"></div>

  <div id="stageTablesContainer"></div>

  <div class="top-row">
    <label>
      خامات داخلية
      <input type="text" id="internalMaterial" />
    </label>
    <label>
      خامات خارجية
      <input type="text" id="externalMaterial" />
    </label>
  </div>

  <div class="top-row">
    <label>
      إضافة فني
      <div class="field-inline">
        <input type="text" id="newTech" placeholder="اسم الفني">
        <button id="btnAddTech">+</button>
      </div>
    </label>
  </div>

  <template id="tpl-basic-row">
    <tr>
      <td><input type="text" class="item-type" placeholder="نوع البند"></td>
      <td><input type="text" class="item-name" placeholder="اسم البند"></td>
      <td>
        <select class="tech-list">
          <option value="">-- اختر فني --</option>
        </select>
      </td>
      <td><input type="datetime-local" class="start-date" dir="ltr"></td>
      <td><input type="datetime-local" class="end-date" dir="ltr"></td>
      <td class="duration-display">00:00:00</td>
      <td><textarea class="notes" rows="1"></textarea></td>
      <td>
        <select class="status-select">
          <option value="not-started">لم يبدأ</option>
          <option value="progress">جاري العمل</option>
          <option value="done">تم</option>
          <option value="error">خطأ</option>
        </select>
      </td>
      <td><button class="remove-row-btn">حذف</button></td>
    </tr>
  </template>

  <template id="tpl-advanced-row">
    <tr>
      <td><input type="text" class="item-type" placeholder="نوع البند"></td>
      <td><input type="text" class="item-name" placeholder="اسم البند"></td>
      <td>
        <select class="tech-list">
          <option value="">-- اختر فني --</option>
        </select>
      </td>
      <td><input type="datetime-local" class="start-date" dir="ltr"></td>
      <td><input type="datetime-local" class="end-date" dir="ltr"></td>
      <td class="duration-display">00:00:00</td>
      <td><input type="text" class="units" placeholder="الوحدات"></td>
      <td><textarea class="notes" rows="1"></textarea></td>
      <td>
        <select class="status-select">
          <option value="not-started">لم يبدأ</option>
          <option value="progress">جاري العمل</option>
          <option value="done">تم</option>
          <option value="error">خطأ</option>
        </select>
      </td>
      <td><button class="remove-row-btn">حذف</button></td>
    </tr>
  </template>

  <script>
    const url = 'https://script.google.com/macros/s/AKfycbz7PbqLYqM-iD3AI84qcq_raDS9HLAwxRKSo9V3IBjC3UZD-AoEdghnRSiOpSJjEteqoQ/exec';
    const byId = id => document.getElementById(id);

    const STAGES = [
      { id: 'التقطيع', basic: true },
      { id: 'المفحار', basic: true },
      { id: 'القشاط/الشريط', basic: true },
      { id: 'المكبس', basic: false },
      { id: 'المرحلية 1', basic: false },
      { id: 'CNC', basic: false },
      { id: 'المرحليه 2', basic: false },
      { id: 'التجميع', basic: false },
      { id: 'الجودة النهائية', basic: false }
    ];

    let technicians = [];

    function loading(show) {
      byId('loadingOverlay').classList.toggle('visible', show);
    }

    function populateTechSelects() {
      const techSelects = document.querySelectorAll('.tech-list');
      techSelects.forEach(select => {
        const selectedValue = select.value;
        select.innerHTML = '<option value="">-- اختر فني --</option>';
        technicians.forEach(tech => {
          const option = document.createElement('option');
          option.value = tech;
          option.textContent = tech;
          select.appendChild(option);
        });
        select.value = selectedValue;
      });
    }

    function populateSavedCodesDropdown(codes) {
      const select = byId('savedCodesDropdown');
      select.innerHTML = '<option value="">-- اختر كود --</option>';
      codes.forEach(code => {
        const option = document.createElement('option');
        option.value = code;
        option.textContent = code;
        select.appendChild(option);
      });
    }

    function calculateDuration(start, end) {
      if (!start || !end) return '00:00:00';
      const startDate = new Date(start);
      const endDate = new Date(end);
      if (endDate < startDate) return '00:00:00';
      
      const diffInMilliseconds = endDate - startDate;
      const hours = Math.floor(diffInMilliseconds / 3600000);
      const minutes = Math.floor((diffInMilliseconds % 3600000) / 60000);
      const seconds = Math.floor((diffInMilliseconds % 60000) / 1000);
      
      return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }

    function updateRowColor(row) {
      const status = row.querySelector('.status-select').value;
      const statuses = ['not-started', 'progress', 'done', 'error'];
      statuses.forEach(s => row.classList.remove(s));
      row.classList.add(status.replace(/\s+/g, '-').replace(/[^ء-ي\w\s-]/g, ''));
    }

    function setupRow(row) {
      const startDateInput = row.querySelector('.start-date');
      const endDateInput = row.querySelector('.end-date');
      const durationCell = row.querySelector('.duration-display');
      const statusSelect = row.querySelector('.status-select');
      const removeBtn = row.querySelector('.remove-row-btn');

      if(startDateInput && endDateInput) {
        const updateDuration = () => {
          const duration = calculateDuration(startDateInput.value, endDateInput.value);
          if (durationCell) durationCell.textContent = duration;
        };
        startDateInput.addEventListener('change', updateDuration);
        endDateInput.addEventListener('change', updateDuration);
      }
      
      if (statusSelect) {
        statusSelect.addEventListener('change', () => updateRowColor(row));
      }
      
      if(removeBtn) {
        removeBtn.addEventListener('click', () => {
          row.remove();
        });
      }
    }

    function appendEmptyRowTo(tableId) {
      const stageId = tableId.replace('stage-', '');
      const stage = STAGES.find(s => 'stage-' + s.id.replace(/\s+/g, '-').replace(/[^ء-ي\w\s-]/g, '') === tableId);
      const tpl = document.getElementById(stage.basic ? 'tpl-basic-row' : 'tpl-advanced-row');
      const clone = tpl.content.cloneNode(true);
      const tr = clone.querySelector('tr');
      tr.dataset.stage = stage.id;
      
      byId(tableId).querySelector('tbody').appendChild(tr);
      setupRow(tr);
      populateTechSelects();
    }

    function appendExistingRowTo(tableId, r) {
      const stageId = tableId.replace('stage-', '');
      const stage = STAGES.find(s => 'stage-' + s.id.replace(/\s+/g, '-').replace(/[^ء-ي\w\s-]/g, '') === tableId);
      const tbody = byId(tableId).querySelector('tbody');
      const tpl = document.getElementById(stage.basic ? 'tpl-basic-row' : 'tpl-advanced-row');
      const clone = tpl.content.cloneNode(true);
      const tr = clone.querySelector('tr');
      tr.dataset.stage = stage.id;
      
      if(tr.querySelector('.item-type')) tr.querySelector('.item-type').value = r.type || "";
      if(tr.querySelector('.item-name')) tr.querySelector('.item-name').value = r.itemName || "";
      if(tr.querySelector('.tech-list')){
        populateSingleTechSelect(tr.querySelector('.tech-list'));
        tr.querySelector('.tech-list').value = r.tech || "";
      }
      if(tr.querySelector('.start-date')) tr.querySelector('.start-date').value = r.start || "";
      if(tr.querySelector('.end-date')) tr.querySelector('.end-date').value = r.end || "";
      if(r.duration) { tr.dataset.duration = r.duration; if(tr.querySelector('.duration-display')) tr.querySelector('.duration-display').textContent = r.duration; }
      if(tr.querySelector('.units')) tr.querySelector('.units').value = r.units || "";
      if(tr.querySelector('.notes')) tr.querySelector('.notes').value = r.notes || "";
      if(tr.querySelector('.status-select')) tr.querySelector('.status-select').value = r.status || "";
      
      tbody.appendChild(tr);
      setupRow(tr);
      updateRowColor(tr);
    }
    
    function populateSingleTechSelect(select) {
        select.innerHTML = '<option value="">-- اختر فني --</option>';
        technicians.forEach(tech => {
          const option = document.createElement('option');
          option.value = tech;
          option.textContent = tech;
          select.appendChild(option);
        });
    }

    async function loadForClientCode(clientCode) {
      loading(true);
      try {
        const res = await fetch(url + '?clientCode=' + clientCode);
        const result = await res.json();
        loading(false);

        if (result.success) {
          const data = result.data;
          if (data) {
            byId('clientName').value = data.clientName || "";
            byId('projectName').value = data.projectName || "";
            byId('internalMaterial').value = data.internalMaterial || "";
            byId('externalMaterial').value = data.externalMaterial || "";
            byId('formTitle').textContent = `متابعة إنتاج — ${data.projectName}`;

            technicians = data.technicians;
            populateTechSelects();

            // Clear existing rows
            STAGES.forEach(s => byId('stage-' + s.id.replace(/\s+/g, '-').replace(/[^ء-ي\w\s-]/g, '')).querySelector('tbody').innerHTML = '');

            // Render data rows for each stage
            for (const stage of STAGES) {
              const stageData = data.stages[stage.id];
              if (stageData && stageData.length > 0) {
                stageData.forEach(r => appendExistingRowTo('stage-' + stage.id.replace(/\s+/g, '-').replace(/[^ء-ي\w\s-]/g, ''), r));
              } else {
                appendEmptyRowTo('stage-' + stage.id.replace(/\s+/g, '-').replace(/[^ء-ي\w\s-]/g, ''));
              }
            }
          } else {
            alert("لم يتم العثور على كود العميل.");
          }
        } else {
          alert("خطأ: " + result.error);
        }
      } catch (error) {
        loading(false);
        console.error("Error fetching data:", error);
        alert("حدث خطأ أثناء جلب البيانات: " + error.message);
      }
    }
    
    function renderStageTables() {
      const container = byId('stageTablesContainer');
      const tabButtons = byId('tabButtons');
      STAGES.forEach((stage, index) => {
        const stageId = stage.id.replace(/\s+/g, '-').replace(/[^ء-ي\w\s-]/g, '');
        const tableHtml = `
          <div id="stage-table-${stageId}" class="stage-table-container">
            <table class="stage-table">
              <caption>${stage.id}</caption>
              <thead>
                <tr>
                  <th>نوع البند</th>
                  <th>اسم البند</th>
                  <th>اسم الفني</th>
                  <th>البدء</th>
                  <th>الانتهاء</th>
                  <th>المدة</th>
                  ${stage.basic ? '' : '<th>الوحدات</th>'}
                  <th>ملاحظات</th>
                  <th>الحالة</th>
                  <th>إجراء</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <button class="add-row-btn" data-table-id="stage-table-${stageId}">+ إضافة بند</button>
          </div>
        `;
        const buttonHtml = `<button data-target="stage-table-${stageId}" class="${index === 0 ? 'active' : ''}">${stage.id}</button>`;
        container.innerHTML += tableHtml;
        tabButtons.innerHTML += buttonHtml;
      });
      
      byId('tabButtons').querySelectorAll('button').forEach(button => {
        button.addEventListener('click', () => {
          byId('tabButtons').querySelectorAll('button').forEach(b => b.classList.remove('active'));
          button.classList.add('active');
          document.querySelectorAll('.stage-table-container').forEach(table => {
            table.classList.remove('active');
          });
          byId(button.dataset.target).classList.add('active');
        });
      });
      document.querySelector('.stage-table-container').classList.add('active');

      document.querySelectorAll('.add-row-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          appendEmptyRowTo(btn.dataset.tableId);
        });
      });
    }

    function collectData() {
        const data = {
            clientCode: byId('clientCode').value,
            clientName: byId('clientName').value,
            projectName: byId('projectName').value,
            internalMaterial: byId('internalMaterial').value,
            externalMaterial: byId('externalMaterial').value,
            stages: {}
        };

        STAGES.forEach(stage => {
            const tableId = `stage-table-${stage.id.replace(/\s+/g, '-').replace(/[^ء-ي\w\s-]/g, '')}`;
            const rows = byId(tableId).querySelectorAll('tbody tr');
            const stageData = [];
            rows.forEach(row => {
                const rowData = {
                    type: row.querySelector('.item-type').value,
                    itemName: row.querySelector('.item-name').value,
                    tech: row.querySelector('.tech-list').value,
                    start: row.querySelector('.start-date').value,
                    end: row.querySelector('.end-date').value,
                    duration: row.querySelector('.duration-display').textContent,
                    notes: row.querySelector('.notes').value,
                    status: row.querySelector('.status-select').value
                };
                if (!stage.basic) {
                    rowData.units = row.querySelector('.units').value;
                }
                stageData.push(rowData);
            });
            data.stages[stage.id] = stageData;
        });

        return data;
    }

    async function saveAll() {
      loading(true);
      const data = collectData();
      try {
        const res = await fetch(url, {
          method: 'POST',
          body: JSON.stringify(data),
          headers: { 'Content-Type': 'application/json' }
        });
        const result = await res.json();
        loading(false);

        if (result.success) {
          alert("تم حفظ البيانات بنجاح!");
        } else {
          alert("خطأ: " + result.error);
        }
      } catch (error) {
        loading(false);
        console.error("Error saving data:", error);
        alert("حدث خطأ أثناء حفظ البيانات: " + error.message);
      }
    }

    function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      const tables = [];
      STAGES.forEach(stage => {
          const table = document.getElementById(`stage-table-${stage.id.replace(/\s+/g, '-').replace(/[^ء-ي\w\s-]/g, '')}`);
          if (table) {
              const head = Array.from(table.querySelector('thead tr').children).slice(0, -1).map(th => th.textContent);
              const body = Array.from(table.querySelector('tbody').children).map(tr => Array.from(tr.children).slice(0, -1).map(td => {
                  const input = td.querySelector('input, select, textarea');
                  if (input) return input.value;
                  return td.textContent;
              }));
              tables.push({ id: stage.id, head: head, body: body });
          }
      });

      let startY = 10;
      doc.setFont('Amiri', 'normal');
      doc.addFont('Amiri-Regular.ttf', 'Amiri', 'normal');
      doc.addFont('Amiri-Bold.ttf', 'Amiri', 'bold');

      doc.text(`متابعة إنتاج — ${byId('projectName').value}`, 105, startY, null, null, 'center');
      startY += 10;
      doc.setFontSize(10);
      doc.text(`كود العميل: ${byId('clientCode').value}`, 10, startY, { align: 'right' });
      doc.text(`اسم العميل: ${byId('clientName').value}`, 10, startY + 5, { align: 'right' });
      doc.text(`خامات داخلية: ${byId('internalMaterial').value}`, 10, startY + 10, { align: 'right' });
      doc.text(`خامات خارجية: ${byId('externalMaterial').value}`, 10, startY + 15, { align: 'right' });
      startY += 25;

      tables.forEach(table => {
          doc.addPage();
          doc.setFontSize(14);
          doc.text(table.id, 105, 15, null, null, 'center');
          
          doc.autoTable({
              startY: 20,
              head: [table.head],
              body: table.body,
              theme: 'grid',
              styles: { font: 'Amiri', fontStyle: 'normal', halign: 'center' },
              headStyles: { fontStyle: 'bold', fillColor: [230, 242, 255] },
              bodyStyles: { font: 'Amiri', fontStyle: 'normal' },
              didDrawCell: data => {
                  if (data.cell.text[0] === 'تم' || data.cell.text[0] === 'done') {
                      doc.setFillColor(230, 247, 234);
                      doc.rect(data.cell.x, data.cell.y, data.cell.width, data.cell.height, 'F');
                  }
              }
          });
      });

      doc.save(`متابعة_إنتاج_${byId('clientCode').value}.pdf`);
    }

    byId('btnSearch').addEventListener('click', () => {
      const code = byId('clientCode').value;
      if (!code) return alert('أدخل كود العميل');
      loadForClientCode(code);
    });

    byId('btnLoad').addEventListener('click', () => {
      const code = byId('savedCodesDropdown').value;
      if (!code) return alert('اختر كود من القائمة');
      loadForClientCode(code);
    });

    byId('btnSave').addEventListener('click', saveAll);
    byId('btnExportPDF').addEventListener('click', exportPDF);
    byId('btnExportJSON').addEventListener('click', exportJSON);

    byId('savedCodesDropdown').addEventListener('change', (e) => {
      const v = e.target.value;
      if (v) byId('clientCode').value = v;
    });

    byId('btnAddTech').addEventListener('click', () => {
      const v = byId('newTech').value.trim();
      if (!v) return alert('اكتب اسم الفني ثم اضغط +');
      if (!technicians.includes(v)) technicians.push(v);
      byId('newTech').value = '';
      populateTechSelects();
    });

    async function init() {
      renderStageTables();
      STAGES.forEach(s => appendEmptyRowTo('stage-' + s.id.replace(/\s+/g, '-').replace(/[^ء-ي\w\s-]/g, '')));

      try {
        const res = await fetch(url);
        const result = await res.json();
        if (result.success) {
          technicians = result.technicians;
          populateTechSelects();
        }
      } catch(error) {
        console.error("Error fetching technicians:", error);
      }
    }

    init();
  </script>
</body>
</html>
