<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù†ØªØ§Ø¬ â€” ÙƒØ§Ù…Ù„</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù„ÙˆØ¬Ùˆ Ø§Ù„Ù†ØµÙŠ */
.logo-text {
  font-size: 40px;
  font-weight: bold;
  margin-right: auto; /* Ø¨Ø¯Ù„ margin-left: auto Ù„Ø¶Ù…Ø§Ù† Ø£Ù‚ØµÙ‰ Ø§Ù„Ø´Ù…Ø§Ù„ ÙÙŠ RTL */
  font-family: Arial, Tahoma, sans-serif;
  color: #333;            /* Ù„ÙˆÙ† Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙ„Ù…Ø© (Ø±Ù…Ø§Ø¯ÙŠ ØºØ§Ù…Ù‚) */
}

.logo-text .logo-k {
  color: #2ecc71;         /* Ø­Ø±Ù K Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø®Ø¶Ø± */
}
  body{font-family: Tahoma, Arial; direction:rtl; background:#fff; margin:16px; color:#000}
  h1{text-align:center; color:#009A00; margin-bottom:12px}
  .top-row{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-bottom:8px}
  .top-row label{display:flex;flex-direction:column;min-width:220px;font-size:13px}
  .top-row .field-inline{display:flex;gap:6px;align-items:center}
  .top-row input[type="text"], .top-row select{padding:6px;width:220px;box-sizing:border-box;background:#fff;border:1px solid #333;color:#000}

  .top-controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:12px}
  .top-controls .btn{padding:8px 12px;background:#0b6ed3;color:#fff;border-radius:6px;border:0;cursor:pointer}
  .top-controls .btn.secondary{background:#33BBCD}
  .top-controls select{padding:6px;width:220px;box-sizing:border-box;background:#fff;border:1px solid #333;color:#000}

  .materials-row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:8px}
  .material-input{width:220px;padding:6px;border-radius:4px;border:1px solid #333;box-sizing:border-box;background:#fff;color:#000}
  .material-wrap{display:flex;gap:6px;align-items:center}

  table.stage{width:100%;border-collapse:collapse;margin:18px 0;background:#fff;box-shadow:0 0 0 1px #222}
  table.stage thead th{background:#9DA8AD;color:#fff;padding:8px;text-align:center}
  table.stage thead tr.sub-header th{background:#153e5a;color:#fff;font-weight:600}
  table.stage th, table.stage td{border:1px solid #2b2b2b;padding:6px;vertical-align:middle;text-align:center;color:#eee}
  select,input[type="text"],input[type="number"],input[type="datetime-local"],textarea{width:100%;padding:6px;box-sizing:border-box;font-size:13px;background:#fff;border:1px solid #333;color:#000}
  textarea{resize:none;min-height:40px}

  .btn-square{width:28px;height:28px;border-radius:4px;border:0;cursor:pointer;font-weight:bold;display:inline-flex;align-items:center;justify-content:center}
  .btn-add{background:#0b87ff;color:#fff}
  .btn-del{background:#e74c3c;color:#fff}

  /* row colors (ØºØ§Ù…Ù‚Ø©) */
  tr.status-default{background:##fff} /* Ø§ÙØªØ±Ø§Ø¶ÙŠ (ÙØ§ØªØ­) */
  tr.status-done{background:#1b5e20;color:#fff}   /* Ø£Ø®Ø¶Ø± ØºØ§Ù…Ù‚ */
  tr.status-progress{background:#f57f17;color:#000}/* Ø£ØµÙØ±/Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ ØºØ§Ù…Ù‚ */
  tr.status-error{background:#b71c1c;color:#fff}  /* Ø£Ø­Ù…Ø± ØºØ§Ù…Ù‚ */

  .tech-select{width:220px!important}

  @media (max-width:900px){
    .top-row label{min-width:150px;width:48%}
    .top-row input[type="text"], .top-row select{width:100%}
    table.stage td, table.stage th{font-size:12px;padding:4px}
    .top-controls select, .material-input { width:100%; }
  }

  .msg{font-size:13px;color:#6ec6ff;margin-left:8px}
  .save-btn{padding:10px 16px;background:#0b6ed3;color:#fff;border:0;border-radius:6px;cursor:pointer}

  .del-material{background:#e74c3c;color:#fff;border:0;border-radius:4px;padding:6px 8px;cursor:pointer}
</style>
</head>
<body>
<h1>Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù†ØªØ§Ø¬</h1>

<div class="top-row">
  <label>ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„
    <div class="field-inline">
      <input type="text" id="clientCode" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ù…ÙØªØ§Ø­)"/>
      <button type="button" id="btnSearch" class="btn-square btn-add" title="Ø¨Ø­Ø«">ğŸ”</button>
    </div>
  </label>

  <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„
    <input type="text" id="clientName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„"/>
  </label>

  <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
    <input type="text" id="projectName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"/>
  </label>

  <label>Ø£Ø¶Ù ÙÙ†ÙŠ Ø¬Ø¯ÙŠØ¯
    <div style="display:flex;gap:6px">
      <input type="text" id="newTech" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ÙÙ†ÙŠ"/>
      <button type="button" id="btnAddTech" class="btn-square btn-add" title="Ø£Ø¶Ù ÙÙ†ÙŠ">+</button>
    </div>
  </label>

  <div style="display:flex;align-items:center">
    <span id="recallMsg" class="msg" style="display:none"></span>
  </div>

<div class="logo-text">
  <span class="logo-k">K</span>itchino
</div>
</div>

<div class="top-controls" aria-label="controls">
  <button id="btnSave" class="btn">Ø­ÙØ¸</button>
  <button id="btnExportJSON" class="btn secondary">ØªØµØ¯ÙŠØ± JSON</button>
  <button id="btnExportPDF" class="btn secondary">ØªØµØ¯ÙŠØ± PDF</button>

  <select id="savedCodesDropdown" aria-label="Ø§Ø³ØªØ±Ø¬Ø§Ø¹ ÙƒÙˆØ¯ Ù…Ø­ÙÙˆØ¸" title="Ø§Ø®ØªØ± ÙƒÙˆØ¯ Ù…Ø­ÙÙˆØ¸"></select>
  <button id="btnLoadSaved" class="btn">Ø§Ø³ØªØ±Ø¬Ø§Ø¹</button>

  <input id="internalMaterial" class="material-input" placeholder="Ø§Ù„Ø®Ø§Ù…Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©" title="Ø§Ù„Ø®Ø§Ù…Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©"/>
  <input id="externalMaterial" class="material-input" placeholder="Ø§Ù„Ø®Ø§Ù…Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©" title="Ø§Ù„Ø®Ø§Ù…Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©"/>
  <button id="btnAddMaterial" class="btn">+</button>

<label style="margin-inline-start:15px">
    <input type="checkbox" id="chkStorage"/> Ù…Ø®Ø²Ù†
  </label>
  <label style="margin-inline-start:10px">
    <input type="checkbox" id="chkSupply"/> ØªÙˆØ±ÙŠØ¯
  </label>
</div>

<div id="extraMaterialsContainer" class="materials-row"></div>

<form id="prodForm">
  <template id="tpl-basic-row">
    <tr class="data-row status-default">
      <td>
        <div style="display:flex;align-items:center;gap:6px;justify-content:flex-end">
          <select class="item-type">
            <option value="">Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø¯</option>
            <option>Ù‡ÙŠÙƒÙ„</option>
            <option>HPL</option>
            <option>Ø¶Ù„ÙØ©</option>
          </select>
          <button type="button" class="btn-square btn-add btn-add-inline" title="Ø£Ø¶Ù ØµÙ">+</button>
        </div>
      </td>

      <td>
        <div style="display:flex;gap:6px;align-items:center;justify-content:flex-end">
          <input type="text" class="item-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ø¯"/>
          <button type="button" class="btn-square btn-del btn-del-inline" title="Ø­Ø°Ù ØµÙ">-</button>
        </div>
      </td>

      <td><select class="tech-list"></select></td>
      <td><input type="datetime-local" class="start-date"/></td>
      <td><input type="datetime-local" class="end-date"/></td>
      <td><input type="text" class="duration" readonly placeholder="Ø³Ø§Ø¹Ø§Øª"/></td>

      <td colspan="2"><textarea class="notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª..."></textarea></td>

      <td>
        <select class="status-select">
          <option value="">---</option>
          <option value="done">ØªÙ…</option>
          <option value="progress">ØªØ­Øª Ø§Ù„ØªØ´ØºÙŠÙ„</option>
          <option value="error">Ù…ØªØ¹Ø·Ù„ / Ù†Ù‚Øµ Ø®Ø§Ù…Ø©</option>
        </select>
      </td>
    </tr>
  </template>

  <template id="tpl-advanced-row">
    <tr class="data-row status-default">
      <td>
        <div style="display:flex;align-items:center;gap:6px;justify-content:flex-end">
          <select class="item-type">
            <option value="">Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø¯</option>
            <option>Ù‡ÙŠÙƒÙ„</option>
            <option>HPL</option>
            <option>Ø¶Ù„ÙØ©</option>
          </select>
          <button type="button" class="btn-square btn-add btn-add-inline" title="Ø£Ø¶Ù ØµÙ">+</button>
        </div>
      </td>

      <td>
        <div style="display:flex;gap:6px;align-items:center;justify-content:flex-end">
          <input type="text" class="item-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ø¯"/>
          <button type="button" class="btn-square btn-del btn-del-inline" title="Ø­Ø°Ù ØµÙ">-</button>
        </div>
      </td>

      <td><select class="tech-list"></select></td>
      <td><input type="datetime-local" class="start-date"/></td>
      <td><input type="datetime-local" class="end-date"/></td>
      <td><input type="text" class="duration" readonly placeholder="Ø³Ø§Ø¹Ø§Øª"/></td>
      <td><input type="number" class="units" min="0" placeholder="Ø¹Ø¯Ø¯"/></td>
      <td><textarea class="notes" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª..."></textarea></td>
      <td>
        <select class="status-select">
          <option value="">---</option>
          <option value="done">ØªÙ…</option>
          <option value="progress">ØªØ­Øª Ø§Ù„ØªØ´ØºÙŠÙ„</option>
          <option value="error">Ù…ØªØ¹Ø·Ù„ / Ù†Ù‚Øµ Ø®Ø§Ù…Ø©</option>
        </select>
      </td>
    </tr>
  </template>

  <div id="stagesContainer"></div>
</form>

<script>
const STAGES = [
  { id: "Ø§Ù„ØªÙ‚Ø·ÙŠØ¹", basic: true },
  { id: "Ø§Ù„Ù…ÙØ­Ø§Ø±", basic: true },
  { id: "Ø§Ù„Ù‚Ø´Ø§Ø·/Ø§Ù„Ø´Ø±ÙŠØ·", basic: true },
  { id: "Ø§Ù„Ù…ÙƒØ¨Ø³", basic: false },
  { id: "Ø§Ù„Ù…Ø±Ø­Ù„ÙŠØ© 1", basic: false },
  { id: "CNC", basic: false },
  { id: "Ø§Ù„Ù…Ø±Ø­Ù„ÙŠÙ‡ 2", basic: false },
  { id: "Ø§Ù„ØªØ¬Ù…ÙŠØ¹", basic: false },
  { id: "Ø§Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©", basic: false }
];

let technicians = JSON.parse(localStorage.getItem('motabaa_techs') || '["Ù…Ø­Ù…ÙˆØ¯","ÙŠÙˆØ³Ù","Ø¹Ø¨Ø¯ Ø§Ù„Ø³ØªØ§Ø±","Ù…Ø­Ù…Ø¯ Ø±Ø¨ÙŠØ¹"]');
let clientsData = JSON.parse(localStorage.getItem('motabaa_clients') || '{}');

function byId(id){ return document.getElementById(id); }
function create(tag, html){ const e = document.createElement(tag); if(html) e.innerHTML = html; return e; }

// sanitize id generator (Ù…Ø«Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…)
function stageId(stageName){
  return 'stage-' + stageName.replace(/\s+/g,'-').replace(/[^\w\-Ø¡-ÙŠ]/g,'');
}

// Ø±Ù†Ø¯Ø±Ø© Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ù„ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„
function renderStageTables(){
  const container = byId('stagesContainer');
  container.innerHTML = '';
  STAGES.forEach(stage=>{
    const tbl = create('table');
    tbl.className = 'stage';
    tbl.id = stageId(stage.id);
    const title = `
      <thead>
        <tr><th colspan="${ stage.basic ? 9 : 9 }">${stage.id}</th></tr>
        <tr>
          <th>Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø¯</th>
          <th>Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ø¯</th>
          <th>Ø§Ø³Ù… Ø§Ù„ÙÙ†ÙŠ</th>
          <th>Ø¨Ø¯Ø¡</th>
          <th>Ø§Ù†ØªÙ‡Ø§Ø¡</th>
          <th>Ù…Ø¯Ø© ØªØ´ØºÙŠÙ„</th>
          ${ stage.basic ? '<th colspan="2">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>' : '<th>Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>' }
          <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
        </tr>
      </thead>
      <tbody></tbody>
    `;
    tbl.innerHTML = title;
    container.appendChild(tbl);
    // ØµÙ Ø£ÙˆÙ„ÙŠ
    addRowToTable(tbl, stage.basic);
  });
}

// ØªÙ„ÙˆÙŠÙ† Ø§Ù„ØµÙ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© (Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù‚ÙŠÙ… text: done/progress/error)
function colorRowByStatus(row, status){
  row.classList.remove('status-default','status-done','status-progress','status-error');
  if(status === 'done') row.classList.add('status-done');
  else if(status === 'progress') row.classList.add('status-progress');
  else if(status === 'error') row.classList.add('status-error');
  else row.classList.add('status-default');
}

// Ø¥Ø¶Ø§ÙØ© ØµÙ Ø¬Ø¯ÙŠØ¯ Ø¥Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ØŒ Ù…Ø¹ Ø¯Ø¹Ù… Ù…Ù„Ø¦ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø°Ø§ ØªÙˆÙØ±Øª rowData
function addRowToTable(table, basic = true, rowData = null){
  const tpl = basic ? byId('tpl-basic-row') : byId('tpl-advanced-row');
  const clone = tpl.content.cloneNode(true);
  const row = clone.querySelector('tr');

  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙÙ†ÙŠÙŠÙ† Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
  const techSelect = row.querySelector('.tech-list');
  techSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙÙ†ÙŠ</option>';
  technicians.forEach(t=>{
    const opt = create('option'); opt.value = t; opt.textContent = t; techSelect.appendChild(opt);
  });

  // ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø§Ù„ØµÙ Ø­Ø³Ø¨ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
  const statusSelect = row.querySelector('.status-select');
  statusSelect.addEventListener('change', e=>{
    colorRowByStatus(row, e.target.value);
  });
// Ø­Ø³Ø§Ø¨ Ù…Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (Ø³Ø§Ø¹Ø§Øª ÙˆØ¯Ù‚Ø§Ø¦Ù‚)
  const startInput = row.querySelector('.start-date');
  const endInput = row.querySelector('.end-date');
  const durationInput = row.querySelector('.duration');

  function updateDuration(){
    if(startInput && endInput && durationInput && startInput.value && endInput.value){
      const start = new Date(startInput.value);
      const end = new Date(endInput.value);
      let diff = (end - start) / 1000; // ÙØ±Ù‚ Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ
      if(diff > 0){
        const hours = Math.floor(diff/3600);
        const minutes = Math.floor((diff % 3600)/60);
        durationInput.value = `${hours}Ø³ ${minutes}Ø¯`;
      } else {
        durationInput.value = '';
      }
    } else if(durationInput){
      durationInput.value = '';
    }
  }

  if(startInput) startInput.addEventListener('change', updateDuration);
  if(endInput) endInput.addEventListener('change', updateDuration);

  // Ø£Ø²Ø±Ø§Ø± Ø¥Ø¶Ø§ÙØ©/Ø­Ø°Ù ØµÙ
  row.querySelectorAll('.btn-add-inline').forEach(btn=>{
    btn.addEventListener('click', ()=> addRowToTable(table, basic));
  });
  row.querySelectorAll('.btn-del-inline').forEach(btn=>{
    btn.addEventListener('click', ()=> row.remove());
  });

  // Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª
  if(rowData){
    const setIf = (sel, val) => { if(sel && typeof val !== 'undefined' && val !== null) sel.value = val; };
    setIf(row.querySelector('.item-type'), rowData.type || '');
    setIf(row.querySelector('.item-name'), rowData.name || '');
    setIf(row.querySelector('.tech-list'), rowData.tech || '');
    setIf(row.querySelector('.start-date'), rowData.start || '');
    setIf(row.querySelector('.end-date'), rowData.end || '');
    setIf(row.querySelector('.duration'), rowData.duration || '');
    if(row.querySelector('.units')) setIf(row.querySelector('.units'), rowData.units || '');
    setIf(row.querySelector('.notes'), rowData.notes || '');
    setIf(row.querySelector('.status-select'), rowData.status || '');
    // Ù„Ùˆ ØºÙŠØ±Ù†Ø§ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ù†ÙØ¹Ù„ Ø§Ù„Ø­Ø¯Ø« Ù„ØªÙ„ÙˆÙŠÙ† Ø§Ù„ØµÙ
    if(rowData.status) {
      colorRowByStatus(row, rowData.status);
    }
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯Ø© Ø¨Ø¹Ø¯ ÙˆØ¶Ø¹ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®
    updateDuration();
  } else {
    // Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    row.classList.add('status-default');
  }

  table.querySelector('tbody').appendChild(clone);
}

// Ø¥Ø¶Ø§ÙØ© ÙÙ†ÙŠ Ø¬Ø¯ÙŠØ¯
byId('btnAddTech').addEventListener('click', ()=>{
  const val = byId('newTech').value.trim();
  if(!val) return alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ÙÙ†ÙŠ');
  if(!technicians.includes(val)) technicians.push(val);
  localStorage.setItem('motabaa_techs', JSON.stringify(technicians));
  // Ø­Ø¯Ù‘Ø« ÙƒÙ„ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  updateTechSelects();
  byId('newTech').value = '';
});

// ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„ÙÙ†ÙŠÙŠÙ† Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
function updateTechSelects(){
  document.querySelectorAll('.tech-list').forEach(sel=>{
    const current = sel.value;
    sel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙÙ†ÙŠ</option>';
    technicians.forEach(t=>{
      const opt = create('option'); opt.value = t; opt.textContent = t; sel.appendChild(opt);
    });
    sel.value = current || '';
  });
}
// Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø¥Ø¶Ø§ÙÙŠØ©
byId('btnAddMaterial').addEventListener('click', ()=>{
  const intMat = byId('internalMaterial').value.trim();
  const extMat = byId('externalMaterial').value.trim();
  if(!intMat && !extMat) return;
  const div = create('div'); div.className='material-wrap';
  if(intMat) div.appendChild(create('span',`Ø§Ù„Ø®Ø§Ù…Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©: ${intMat}`));
  if(extMat) div.appendChild(create('span',`Ø§Ù„Ø®Ø§Ù…Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©: ${extMat}`));
  const delBtn = create('button', '-'); delBtn.className='del-material'; delBtn.onclick = ()=> div.remove();
  div.appendChild(delBtn);
  byId('extraMaterialsContainer').appendChild(div);
  byId('internalMaterial').value=''; byId('externalMaterial').value='';
});

// Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ÙŠØ³ØªØ¨Ø¯Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„ÙŠ
byId('btnSave').addEventListener('click', ()=>{
  const stagesData = [];
  STAGES.forEach(stage=>{
    const tbl = byId(stageId(stage.id));
    if(!tbl) return;
    tbl.querySelectorAll('tbody tr').forEach(row=>{
      stagesData.push({
        stage: stage.id,
        type: row.querySelector('.item-type').value,
        name: row.querySelector('.item-name').value,
        tech: row.querySelector('.tech-list').value,
        start: row.querySelector('.start-date').value,
        end: row.querySelector('.end-date').value,
        duration: row.querySelector('.duration').value,
        units: row.querySelector('.units') ? row.querySelector('.units').value : '',
        notes: row.querySelector('.notes').value,
        status: row.querySelector('.status-select').value
      });
    });
  });

  const clientCode = byId('clientCode').value.trim();
  if(!clientCode) return alert('Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸');

  // Ø¬Ù…Ø¹ Ø§Ù„Ø®Ø§Ù…Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©
  const extraMaterials = [];
  document.querySelectorAll('#extraMaterialsContainer .material-wrap').forEach(div=>{
    const spans = div.querySelectorAll('span');
    let internal = '', external = '';
    if(spans[0] && spans[0].textContent.includes('Ø§Ù„Ø®Ø§Ù…Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©:')) internal = spans[0].textContent.replace('Ø§Ù„Ø®Ø§Ù…Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©: ','');
    if(spans[1] && spans[1].textContent.includes('Ø§Ù„Ø®Ø§Ù…Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©:')) external = spans[1].textContent.replace('Ø§Ù„Ø®Ø§Ù…Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©: ','');
    // handle single-span cases
    if(spans.length === 1){
      const t = spans[0].textContent;
      if(t.includes('Ø§Ù„Ø®Ø§Ù…Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©:')) internal = t.replace('Ø§Ù„Ø®Ø§Ù…Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©: ','');
      else if(t.includes('Ø§Ù„Ø®Ø§Ù…Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©:')) external = t.replace('Ø§Ù„Ø®Ø§Ù…Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©: ','');
    }
    if(internal || external) extraMaterials.push({internal, external});
  });

  const today = new Date().toLocaleDateString("ar-EG");
  const now = new Date().toLocaleString("ar-EG");

  const dataToSend = {
    'ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„': clientCode,
    'Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„': byId('clientName').value,
    'Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹': byId('projectName').value,
    'Ø§Ù„Ø®Ø§Ù…Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©': byId('internalMaterial').value,
    'Ø§Ù„Ø®Ø§Ù…Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©': byId('externalMaterial').value,
    'Ø®Ø§Ù…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©': extraMaterials,
    'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø­Ù„': stagesData,
    'Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«': now,
    'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ®Ø²ÙŠÙ†': byId('chkStorage').checked ? today : "",
    'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙˆØ±ÙŠØ¯': byId('chkSupply').checked  ? today : ""
  };

  // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Google Apps Script
  fetch('https://script.google.com/macros/s/AKfycbzH-RZg4LBcKwpGwA0vKqb38nacd2Cq5zfVii56oH9Ed4kDsL9CspODlyJWrJIdZK5FcQ/exec', {
      method: 'POST',
      body: JSON.stringify(dataToSend),
      headers: {
          'Content-Type': 'text/plain;charset=utf-8'
      }
  })
  .then(response => response.json())
  .then(result => {
      if (result.status === 'success') {
          alert('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ø¬ÙˆØ¬Ù„ Ø´ÙŠØªØ³!');
      } else {
          alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸.');
      }
  })
  .catch(error => {
      console.error('Error:', error);
      alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….');
  });
});

// Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…ØµØ­Ø­ Ù„Ø²Ø± Ø§Ù„Ø¨Ø­Ø«
byId('btnSearch').addEventListener('click', ()=>{
  const clientCode = byId('clientCode').value.trim();
  if(!clientCode) {
    alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹.');
    return;
  }
  
  // URL Ø§Ù„Ø®Ø§Øµ Ø¨Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« (doGet) ÙÙŠ Google Apps Script
  const url = `https://script.google.com/macros/s/AKfycbzH-RZg4LBcKwpGwA0vKqb38nacd2Cq5zfVii56oH9Ed4kDsL9CspODlyJWrJIdZK5FcQ/exec?clientCode=${clientCode}`;

  fetch(url)
    .then(response => response.json())
    .then(clientData => {
      if (clientData && clientData.status !== 'error') {
        // Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        byId('clientName').value = clientData['Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„'] || '';
        byId('projectName').value = clientData['Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹'] || '';
        byId('internalMaterial').value = clientData['Ø§Ù„Ø®Ø§Ù…Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©'] || '';
        byId('externalMaterial').value = clientData['Ø§Ù„Ø®Ø§Ù…Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©'] || '';

        // ØªÙØ±ÙŠØº ÙˆØ¥Ø¹Ø§Ø¯Ø© Ù…Ù„Ø¡ Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„
        STAGES.forEach(stage => {
          const tbl = byId(stageId(stage.id));
          if (tbl) {
            tbl.querySelector('tbody').innerHTML = '';
          }
        });
        
        if (clientData['Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø­Ù„'] && clientData['Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø­Ù„'].length > 0) {
          clientData['Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø§Ø­Ù„'].forEach(stageRow => {
            const stageTable = byId(stageId(stageRow.stage));
            if (stageTable) {
              const basicStage = STAGES.find(s => s.id === stageRow.stage).basic;
              addRowToTable(stageTable, basicStage, stageRow);
            }
          });
        }
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ù…Ù„Ø¡ Ù‚Ø³Ù… Ø§Ù„Ø®Ø§Ù…Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
        const extraMaterialsContainer = byId('extraMaterialsContainer');
        extraMaterialsContainer.innerHTML = '';
        if (clientData['Ø®Ø§Ù…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©']) {
          const extraMaterials = clientData['Ø®Ø§Ù…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©'].split(' | ');
          extraMaterials.forEach(mat => {
            const parts = mat.split(',').map(p => p.trim());
            const div = create('div'); div.className = 'material-wrap';
            parts.forEach(p => {
              if (p) div.appendChild(create('span', p));
            });
            const delBtn = create('button', '-'); delBtn.className='del-material'; delBtn.onclick = ()=> div.remove();
            div.appendChild(delBtn);
            extraMaterialsContainer.appendChild(div);
          });
        }
        
        alert('ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­.');
      } else {
        alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….');
    });
});
// ØªØ­Ø¯ÙŠØ« Dropdown Ù„Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
function updateSavedCodesDropdown(){
  const dropdown = byId('savedCodesDropdown');
  dropdown.innerHTML = '<option value="">Ø§Ø®ØªØ± ÙƒÙˆØ¯ Ù…Ø­ÙÙˆØ¸</option>';
  Object.keys(clientsData).forEach(code=>{
    const opt = create('option');
    opt.value = code;
    const label = clientsData[code].clientName ? `${code} - ${clientsData[code].clientName}` : code;
    const last = clientsData[code].lastUpdate ? ` (Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${clientsData[code].lastUpdate})` : '';
    opt.textContent = label + last;
    dropdown.appendChild(opt);
  });
}

// Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
function recallClientData(code){
  const client = clientsData[code];
  if(!client) return false;

  byId('clientCode').value = code;
  byId('clientName').value = client.clientName || '';
  byId('projectName').value = client.projectName || '';
  byId('internalMaterial').value = client.internalMaterial || '';
  byId('externalMaterial').value = client.externalMaterial || '';

  // Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
  byId('extraMaterialsContainer').innerHTML = '';
  if(Array.isArray(client.extraMaterials)){
    client.extraMaterials.forEach(mat=>{
      const div = create('div'); div.className = 'material-wrap';
      if(mat.internal) div.appendChild(create('span',`Ø§Ù„Ø®Ø§Ù…Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©: ${mat.internal}`));
      if(mat.external) div.appendChild(create('span',`Ø§Ù„Ø®Ø§Ù…Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©: ${mat.external}`));
      const delBtn = create('button','-'); delBtn.className='del-material'; delBtn.onclick = ()=> div.remove();
      div.appendChild(delBtn);
      byId('extraMaterialsContainer').appendChild(div);
    });
  } else {
    // Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ØµÙÙˆÙØ©ØŒ Ø­Ø§ÙˆÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    if(client.internalMaterial || client.externalMaterial){
      const div = create('div'); div.className = 'material-wrap';
      if(client.internalMaterial) div.appendChild(create('span',`Ø§Ù„Ø®Ø§Ù…Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©: ${client.internalMaterial}`));
      if(client.externalMaterial) div.appendChild(create('span',`Ø§Ù„Ø®Ø§Ù…Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©: ${client.externalMaterial}`));
      const delBtn = create('button','-'); delBtn.className='del-material'; delBtn.onclick = ()=> div.remove();
      div.appendChild(delBtn);
      byId('extraMaterialsContainer').appendChild(div);
    }
  }

  // ØªÙØ±ÙŠØº ÙƒÙ„ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆØ¥Ø¹Ø§Ø¯ØªÙ‡Ø§ Ø¨Ø­Ø³Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  STAGES.forEach(stage=>{
    const tbl = byId(stageId(stage.id));
    if(!tbl) return;
    tbl.querySelector('tbody').innerHTML = '';
    const stageRows = (client.stages || []).filter(r => r.stage === stage.id);
    if(stageRows.length){
      stageRows.forEach(rowData => addRowToTable(tbl, stage.basic, rowData));
    } else {
      // Ù„Ùˆ Ù…ÙÙŠØ´ ØµÙÙˆÙ Ù…Ø®Ø²Ù†Ø©ØŒ Ø¶ÙŠÙ ØµÙ ÙˆØ§Ø­Ø¯ ÙØ§Ø±Øº
      addRowToTable(tbl, stage.basic);
    }
  });

  // ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§ Ù„Ø¹Ø±Ø¶ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„ØªØ®Ø²ÙŠÙ†/Ø§Ù„ØªÙˆØ±ÙŠØ¯ Ø£ÙŠØ¶Ø§Ù‹
  let recallText = `ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª âœ…${client.lastUpdate ? ' (Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ' + client.lastUpdate + ')' : ''}`;
  if(client.storageDate) recallText += ` | ğŸ“¦ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ®Ø²ÙŠÙ†: ${client.storageDate}`;
  if(client.supplyDate)  recallText += ` | ğŸšš ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙˆØ±ÙŠØ¯: ${client.supplyDate}`;

  byId('recallMsg').textContent = recallText;
  byId('recallMsg').style.display = 'inline';
  updateTechSelects();
  return true;
}

// Ø²Ø± Ø§Ù„Ø¨Ø­Ø« ğŸ”
byId('btnSearch').addEventListener('click', ()=>{
  const code = byId('clientCode').value.trim();
  if(!code) return alert('Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù„Ø¨Ø­Ø«');
  if(!recallClientData(code)){
    byId('recallMsg').textContent = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª âŒ';
    byId('recallMsg').style.display = 'inline';
  }
});
// Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù…Ù† DropDown (Ù…Ø­Ø³Ù‘Ù†: ÙŠØ¯Ø¹Ù… change + Ø²Ø± Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹)
const savedDropdown = byId('savedCodesDropdown');

// Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "Ø§Ø³ØªØ±Ø¬Ø§Ø¹"
byId('btnLoadSaved').addEventListener('click', ()=>{
  const code = savedDropdown.value;
  if(!code) return alert('Ø§Ø®ØªØ± ÙƒÙˆØ¯ Ù…Ø­ÙÙˆØ¸ Ø£ÙˆÙ„Ø§Ù‹');
  byId('clientCode').value = code;
  byId('btnSearch').click();
  // Ø§Ø®ØªÙŠØ§Ø±ÙŠ: Ø§Ø±Ø¬Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
  // savedDropdown.selectedIndex = 0;
});

// Ø¹Ù†Ø¯ ØªØºÙŠØ± Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± ÙÙŠ Ø§Ù„Ù€ dropdown â€” ÙŠØ­Ù…Ù‘Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
savedDropdown.addEventListener('change', ()=>{
  const code = savedDropdown.value;
  if(!code) {
    // Ù„Ùˆ Ø§Ø®ØªØ±Øª Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (ÙØ§Ø±Øº) Ù†Ø¹Ù…Ù„ Ù„Ø§ Ø´ÙŠØ¡
    return;
  }
  byId('clientCode').value = code;
  byId('btnSearch').click();
});

// ØªØµØ¯ÙŠØ± JSON (ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø®Ø²Ù†ÙŠÙ†)
byId('btnExportJSON').addEventListener('click', ()=>{
  const dataStr = JSON.stringify(clientsData, null, 2);
  const blob = new Blob([dataStr], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = create('a'); a.href = url; a.download = 'motabaa_clients.json'; a.click();
  URL.revokeObjectURL(url);
});

// ØªØµØ¯ÙŠØ± PDF (Ù„ÙƒÙ„ Ø¹Ù…ÙŠÙ„)
byId('btnExportPDF').addEventListener('click', ()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  let first = true;
  Object.keys(clientsData).forEach(code=>{
    const client = clientsData[code];
    if(!first) doc.addPage(); first = false;
    doc.setFontSize(12);
    doc.text(`ÙƒÙˆØ¯ Ø§Ù„Ø¹Ù…ÙŠÙ„: ${code}`,10,20);
    doc.text(`Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„: ${client.clientName || ''}`,10,28);
    doc.text(`Ø§Ù„Ù…Ø´Ø±ÙˆØ¹: ${client.projectName || ''}`,10,36);
    doc.text(`Ø§Ù„Ø®Ø§Ù…Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©: ${client.internalMaterial || ''}`,10,44);
    doc.text(`Ø§Ù„Ø®Ø§Ù…Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©: ${client.externalMaterial || ''}`,10,52);
    (client.stages || []).forEach((stageRow, idx) => {
      const header = ['Ø§Ù„Ù…Ø±Ø­Ù„Ø©','Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø¯','Ø§Ø³Ù… Ø§Ù„Ø¨Ù†Ø¯','Ø§Ù„ÙÙ†ÙŠ','Ø¨Ø¯Ø¡','Ø§Ù†ØªÙ‡Ø§Ø¡','Ù…Ø¯Ø©','ÙˆØ­Ø¯Ø§Øª','Ù…Ù„Ø§Ø­Ø¸Ø§Øª','Ø§Ù„Ø­Ø§Ù„Ø©'];
      const row = [
        stageRow.stage || '',
        stageRow.type || '',
        stageRow.name || '',
        stageRow.tech || '',
        stageRow.start || '',
        stageRow.end || '',
        stageRow.duration || '',
        stageRow.units || '',
        (stageRow.notes || '').replace(/\n/g,' '),
        stageRow.status || ''
      ];
      doc.autoTable({ head:[header], body:[row], startY: doc.lastAutoTable ? doc.lastAutoTable.finalY + 8 : 60 });
    });
  });
  doc.save('motabaa_clients.pdf');
});

// ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
renderStageTables();
updateTechSelects();
updateSavedCodesDropdown();
</script>
</body>
</html>
