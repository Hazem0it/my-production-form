<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>متابعة إنتاج — كامل</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
/* تنسيق اللوجو النصي */
.logo-text {
  font-size: 40px;
  font-weight: bold;
  margin-right: auto; /* بدل margin-left: auto لضمان أقصى الشمال في RTL */
  font-family: Arial, Tahoma, sans-serif;
  color: #333;            /* لون باقي الكلمة (رمادي غامق) */
}

.logo-text .logo-k {
  color: #2ecc71;         /* حرف K باللون الأخضر */
}
  body{font-family: Tahoma, Arial; direction:rtl; background:#fff; margin:16px; color:#000}
  h1{text-align:center; color:#009A00; margin-bottom:12px}
  .top-row{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-bottom:8px}
  .top-row label{display:flex;flex-direction:column;min-width:220px;font-size:13px}
  .top-row .field-inline{display:flex;gap:6px;align-items:center}
  .top-row input[type="text"], .top-row select{padding:6px;width:220px;box-sizing:border-box;background:#fff;border:1px solid #333;color:#000}

  .top-controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:12px}
  .top-controls .btn{padding:8px 12px;background:#0b6ed3;color:#fff;border-radius:6px;border:0;cursor:pointer}
  .top-controls .btn.secondary{background:#33BBCD}
  .top-controls select{padding:6px;width:220px;box-sizing:border-box;background:#fff;border:1px solid #333;color:#000}

  .materials-row{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:8px}
  .material-input{width:220px;padding:6px;border-radius:4px;border:1px solid #333;box-sizing:border-box;background:#fff;color:#000}
  .material-wrap{display:flex;gap:6px;align-items:center}

  table.stage{width:100%;border-collapse:collapse;margin:18px 0;background:#fff;box-shadow:0 0 0 1px #222}
  table.stage thead th{background:#9DA8AD;color:#fff;padding:8px;text-align:center}
  table.stage thead tr.sub-header th{background:#153e5a;color:#fff;font-weight:600}
  table.stage th, table.stage td{border:1px solid #2b2b2b;padding:6px;vertical-align:middle;text-align:center;color:#eee}
  select,input[type="text"],input[type="number"],input[type="datetime-local"],textarea{width:100%;padding:6px;box-sizing:border-box;font-size:13px;background:#fff;border:1px solid #333;color:#000}
  textarea{resize:none;min-height:40px}

  .btn-square{width:28px;height:28px;border-radius:4px;border:0;cursor:pointer;font-weight:bold;display:inline-flex;align-items:center;justify-content:center}
  .btn-add{background:#0b87ff;color:#fff}
  .btn-del{background:#e74c3c;color:#fff}

  /* row colors (غامقة) */
  tr.status-default{background:##fff} /* افتراضي (فاتح) */
  tr.status-done{background:#1b5e20;color:#fff}   /* أخضر غامق */
  tr.status-progress{background:#f57f17;color:#000}/* أصفر/برتقالي غامق */
  tr.status-error{background:#b71c1c;color:#fff}  /* أحمر غامق */

  .tech-select{width:220px!important}

  @media (max-width:900px){
    .top-row label{min-width:150px;width:48%}
    .top-row input[type="text"], .top-row select{width:100%}
    table.stage td, table.stage th{font-size:12px;padding:4px}
    .top-controls select, .material-input { width:100%; }
  }

  .msg{font-size:13px;color:#6ec6ff;margin-left:8px}
  .save-btn{padding:10px 16px;background:#0b6ed3;color:#fff;border:0;border-radius:6px;cursor:pointer}

  .del-material{background:#e74c3c;color:#fff;border:0;border-radius:4px;padding:6px 8px;cursor:pointer}
</style>
</head>
<body>
<h1>متابعة إنتاج</h1>

<div class="top-row">
  <label>كود العميل
    <div class="field-inline">
      <input type="text" id="clientCode" placeholder="أدخل كود العميل (مفتاح)"/>
      <button type="button" id="btnSearch" class="btn-square btn-add" title="بحث">🔎</button>
    </div>
  </label>

  <label>اسم العميل
    <input type="text" id="clientName" placeholder="اسم العميل"/>
  </label>

  <label>اسم المشروع
    <input type="text" id="projectName" placeholder="اسم المشروع"/>
  </label>

  <label>أضف فني جديد
    <div style="display:flex;gap:6px">
      <input type="text" id="newTech" placeholder="اكتب اسم الفني"/>
      <button type="button" id="btnAddTech" class="btn-square btn-add" title="أضف فني">+</button>
    </div>
  </label>

  <div style="display:flex;align-items:center">
    <span id="recallMsg" class="msg" style="display:none"></span>
  </div>

<div class="logo-text">
  <span class="logo-k">K</span>itchino
</div>
</div>

<div class="top-controls" aria-label="controls">
  <button id="btnSave" class="btn">حفظ</button>
  <button id="btnExportJSON" class="btn secondary">تصدير JSON</button>
  <button id="btnExportPDF" class="btn secondary">تصدير PDF</button>

  <select id="savedCodesDropdown" aria-label="استرجاع كود محفوظ" title="اختر كود محفوظ"></select>
  <button id="btnLoadSaved" class="btn">استرجاع</button>

  <input id="internalMaterial" class="material-input" placeholder="الخامة الداخلية" title="الخامة الداخلية"/>
  <input id="externalMaterial" class="material-input" placeholder="الخامة الخارجية" title="الخامة الخارجية"/>
  <button id="btnAddMaterial" class="btn">+</button>

<label style="margin-inline-start:15px">
    <input type="checkbox" id="chkStorage"/> مخزن
  </label>
  <label style="margin-inline-start:10px">
    <input type="checkbox" id="chkSupply"/> توريد
  </label>
</div>

<div id="extraMaterialsContainer" class="materials-row"></div>

<form id="prodForm">
  <template id="tpl-basic-row">
    <tr class="data-row status-default">
      <td>
        <div style="display:flex;align-items:center;gap:6px;justify-content:flex-end">
          <select class="item-type">
            <option value="">نوع البند</option>
            <option>هيكل</option>
            <option>HPL</option>
            <option>ضلفة</option>
          </select>
          <button type="button" class="btn-square btn-add btn-add-inline" title="أضف صف">+</button>
        </div>
      </td>

      <td>
        <div style="display:flex;gap:6px;align-items:center;justify-content:flex-end">
          <input type="text" class="item-name" placeholder="اسم البند"/>
          <button type="button" class="btn-square btn-del btn-del-inline" title="حذف صف">-</button>
        </div>
      </td>

      <td><select class="tech-list"></select></td>
      <td><input type="datetime-local" class="start-date"/></td>
      <td><input type="datetime-local" class="end-date"/></td>
      <td><input type="text" class="duration" readonly placeholder="ساعات"/></td>

      <td colspan="2"><textarea class="notes" placeholder="ملاحظات..."></textarea></td>

      <td>
        <select class="status-select">
          <option value="">---</option>
          <option value="done">تم</option>
          <option value="progress">تحت التشغيل</option>
          <option value="error">متعطل / نقص خامة</option>
        </select>
      </td>
    </tr>
  </template>

  <template id="tpl-advanced-row">
    <tr class="data-row status-default">
      <td>
        <div style="display:flex;align-items:center;gap:6px;justify-content:flex-end">
          <select class="item-type">
            <option value="">نوع البند</option>
            <option>هيكل</option>
            <option>HPL</option>
            <option>ضلفة</option>
          </select>
          <button type="button" class="btn-square btn-add btn-add-inline" title="أضف صف">+</button>
        </div>
      </td>

      <td>
        <div style="display:flex;gap:6px;align-items:center;justify-content:flex-end">
          <input type="text" class="item-name" placeholder="اسم البند"/>
          <button type="button" class="btn-square btn-del btn-del-inline" title="حذف صف">-</button>
        </div>
      </td>

      <td><select class="tech-list"></select></td>
      <td><input type="datetime-local" class="start-date"/></td>
      <td><input type="datetime-local" class="end-date"/></td>
      <td><input type="text" class="duration" readonly placeholder="ساعات"/></td>
      <td><input type="number" class="units" min="0" placeholder="عدد"/></td>
      <td><textarea class="notes" placeholder="ملاحظات..."></textarea></td>
      <td>
        <select class="status-select">
          <option value="">---</option>
          <option value="done">تم</option>
          <option value="progress">تحت التشغيل</option>
          <option value="error">متعطل / نقص خامة</option>
        </select>
      </td>
    </tr>
  </template>

  <div id="stagesContainer"></div>
</form>

<script>
const STAGES = [
  { id: "التقطيع", basic: true },
  { id: "المفحار", basic: true },
  { id: "القشاط/الشريط", basic: true },
  { id: "المكبس", basic: false },
  { id: "المرحلية 1", basic: false },
  { id: "CNC", basic: false },
  { id: "المرحليه 2", basic: false },
  { id: "التجميع", basic: false },
  { id: "الجودة النهائية", basic: false }
];

let technicians = JSON.parse(localStorage.getItem('motabaa_techs') || '["محمود","يوسف","عبد الستار","محمد ربيع"]');
let clientsData = JSON.parse(localStorage.getItem('motabaa_clients') || '{}');

function byId(id){ return document.getElementById(id); }
function create(tag, html){ const e = document.createElement(tag); if(html) e.innerHTML = html; return e; }

// sanitize id generator (مثل القديم)
function stageId(stageName){
  return 'stage-' + stageName.replace(/\s+/g,'-').replace(/[^\w\-ء-ي]/g,'');
}

// رندرة الجداول لكل المراحل
function renderStageTables(){
  const container = byId('stagesContainer');
  container.innerHTML = '';
  STAGES.forEach(stage=>{
    const tbl = create('table');
    tbl.className = 'stage';
    tbl.id = stageId(stage.id);
    const title = `
      <thead>
        <tr><th colspan="${ stage.basic ? 9 : 9 }">${stage.id}</th></tr>
        <tr>
          <th>نوع البند</th>
          <th>اسم البند</th>
          <th>اسم الفني</th>
          <th>بدء</th>
          <th>انتهاء</th>
          <th>مدة تشغيل</th>
          ${ stage.basic ? '<th colspan="2">ملاحظات</th>' : '<th>عدد الوحدات</th><th>ملاحظات</th>' }
          <th>الحالة</th>
        </tr>
      </thead>
      <tbody></tbody>
    `;
    tbl.innerHTML = title;
    container.appendChild(tbl);
    // صف أولي
    addRowToTable(tbl, stage.basic);
  });
}

// تلوين الصف حسب الحالة (نستخدم القيم text: done/progress/error)
function colorRowByStatus(row, status){
  row.classList.remove('status-default','status-done','status-progress','status-error');
  if(status === 'done') row.classList.add('status-done');
  else if(status === 'progress') row.classList.add('status-progress');
  else if(status === 'error') row.classList.add('status-error');
  else row.classList.add('status-default');
}

// إضافة صف جديد إلى جدول، مع دعم ملئ البيانات إذا توفرت rowData
function addRowToTable(table, basic = true, rowData = null){
  const tpl = basic ? byId('tpl-basic-row') : byId('tpl-advanced-row');
  const clone = tpl.content.cloneNode(true);
  const row = clone.querySelector('tr');

  // إضافة الفنيين للقائمة
  const techSelect = row.querySelector('.tech-list');
  techSelect.innerHTML = '<option value="">اختر الفني</option>';
  technicians.forEach(t=>{
    const opt = create('option'); opt.value = t; opt.textContent = t; techSelect.appendChild(opt);
  });

  // تغيير لون الصف حسب الاختيار
  const statusSelect = row.querySelector('.status-select');
  statusSelect.addEventListener('change', e=>{
    colorRowByStatus(row, e.target.value);
  });
// حساب مدة التشغيل تلقائياً (ساعات ودقائق)
  const startInput = row.querySelector('.start-date');
  const endInput = row.querySelector('.end-date');
  const durationInput = row.querySelector('.duration');

  function updateDuration(){
    if(startInput && endInput && durationInput && startInput.value && endInput.value){
      const start = new Date(startInput.value);
      const end = new Date(endInput.value);
      let diff = (end - start) / 1000; // فرق بالثواني
      if(diff > 0){
        const hours = Math.floor(diff/3600);
        const minutes = Math.floor((diff % 3600)/60);
        durationInput.value = `${hours}س ${minutes}د`;
      } else {
        durationInput.value = '';
      }
    } else if(durationInput){
      durationInput.value = '';
    }
  }

  if(startInput) startInput.addEventListener('change', updateDuration);
  if(endInput) endInput.addEventListener('change', updateDuration);

  // أزرار إضافة/حذف صف
  row.querySelectorAll('.btn-add-inline').forEach(btn=>{
    btn.addEventListener('click', ()=> addRowToTable(table, basic));
  });
  row.querySelectorAll('.btn-del-inline').forEach(btn=>{
    btn.addEventListener('click', ()=> row.remove());
  });

  // ملء البيانات إذا وجدت
  if(rowData){
    const setIf = (sel, val) => { if(sel && typeof val !== 'undefined' && val !== null) sel.value = val; };
    setIf(row.querySelector('.item-type'), rowData.type || '');
    setIf(row.querySelector('.item-name'), rowData.name || '');
    setIf(row.querySelector('.tech-list'), rowData.tech || '');
    setIf(row.querySelector('.start-date'), rowData.start || '');
    setIf(row.querySelector('.end-date'), rowData.end || '');
    setIf(row.querySelector('.duration'), rowData.duration || '');
    if(row.querySelector('.units')) setIf(row.querySelector('.units'), rowData.units || '');
    setIf(row.querySelector('.notes'), rowData.notes || '');
    setIf(row.querySelector('.status-select'), rowData.status || '');
    // لو غيرنا قيمة الحالة نفعل الحدث لتلوين الصف
    if(rowData.status) {
      colorRowByStatus(row, rowData.status);
    }
    // التأكد من حساب المدة بعد وضع التواريخ
    updateDuration();
  } else {
    // الحالة الافتراضية
    row.classList.add('status-default');
  }

  table.querySelector('tbody').appendChild(clone);
}

// إضافة فني جديد
byId('btnAddTech').addEventListener('click', ()=>{
  const val = byId('newTech').value.trim();
  if(!val) return alert('أدخل اسم الفني');
  if(!technicians.includes(val)) technicians.push(val);
  localStorage.setItem('motabaa_techs', JSON.stringify(technicians));
  // حدّث كل القوائم الحالية
  updateTechSelects();
  byId('newTech').value = '';
});

// تحديث جميع قوائم الفنيين الموجودة
function updateTechSelects(){
  document.querySelectorAll('.tech-list').forEach(sel=>{
    const current = sel.value;
    sel.innerHTML = '<option value="">اختر الفني</option>';
    technicians.forEach(t=>{
      const opt = create('option'); opt.value = t; opt.textContent = t; sel.appendChild(opt);
    });
    sel.value = current || '';
  });
}
// إضافة مادة إضافية
byId('btnAddMaterial').addEventListener('click', ()=>{
  const intMat = byId('internalMaterial').value.trim();
  const extMat = byId('externalMaterial').value.trim();
  if(!intMat && !extMat) return;
  const div = create('div'); div.className='material-wrap';
  if(intMat) div.appendChild(create('span',`الخامة الداخلية: ${intMat}`));
  if(extMat) div.appendChild(create('span',`الخامة الخارجية: ${extMat}`));
  const delBtn = create('button', '-'); delBtn.className='del-material'; delBtn.onclick = ()=> div.remove();
  div.appendChild(delBtn);
  byId('extraMaterialsContainer').appendChild(div);
  byId('internalMaterial').value=''; byId('externalMaterial').value='';
});

// هذا الكود يستبدل كود الحفظ الحالي
byId('btnSave').addEventListener('click', ()=>{
  const stagesData = [];
  STAGES.forEach(stage=>{
    const tbl = byId(stageId(stage.id));
    if(!tbl) return;
    tbl.querySelectorAll('tbody tr').forEach(row=>{
      stagesData.push({
        stage: stage.id,
        type: row.querySelector('.item-type').value,
        name: row.querySelector('.item-name').value,
        tech: row.querySelector('.tech-list').value,
        start: row.querySelector('.start-date').value,
        end: row.querySelector('.end-date').value,
        duration: row.querySelector('.duration').value,
        units: row.querySelector('.units') ? row.querySelector('.units').value : '',
        notes: row.querySelector('.notes').value,
        status: row.querySelector('.status-select').value
      });
    });
  });

  const clientCode = byId('clientCode').value.trim();
  if(!clientCode) return alert('أدخل كود العميل قبل الحفظ');

  // جمع الخامات الإضافية المعروضة
  const extraMaterials = [];
  document.querySelectorAll('#extraMaterialsContainer .material-wrap').forEach(div=>{
    const spans = div.querySelectorAll('span');
    let internal = '', external = '';
    if(spans[0] && spans[0].textContent.includes('الخامة الداخلية:')) internal = spans[0].textContent.replace('الخامة الداخلية: ','');
    if(spans[1] && spans[1].textContent.includes('الخامة الخارجية:')) external = spans[1].textContent.replace('الخامة الخارجية: ','');
    // handle single-span cases
    if(spans.length === 1){
      const t = spans[0].textContent;
      if(t.includes('الخامة الداخلية:')) internal = t.replace('الخامة الداخلية: ','');
      else if(t.includes('الخامة الخارجية:')) external = t.replace('الخامة الخارجية: ','');
    }
    if(internal || external) extraMaterials.push({internal, external});
  });

  const today = new Date().toLocaleDateString("ar-EG");
  const now = new Date().toLocaleString("ar-EG");

  const dataToSend = {
    'كود العميل': clientCode,
    'اسم العميل': byId('clientName').value,
    'اسم المشروع': byId('projectName').value,
    'الخامة الداخلية': byId('internalMaterial').value,
    'الخامة الخارجية': byId('externalMaterial').value,
    'خامات إضافية': extraMaterials,
    'بيانات المراحل': stagesData,
    'آخر تحديث': now,
    'تاريخ التخزين': byId('chkStorage').checked ? today : "",
    'تاريخ التوريد': byId('chkSupply').checked  ? today : ""
  };

  // إرسال البيانات إلى Google Apps Script
  fetch('https://script.google.com/macros/s/AKfycbzH-RZg4LBcKwpGwA0vKqb38nacd2Cq5zfVii56oH9Ed4kDsL9CspODlyJWrJIdZK5FcQ/exec', {
      method: 'POST',
      body: JSON.stringify(dataToSend),
      headers: {
          'Content-Type': 'text/plain;charset=utf-8'
      }
  })
  .then(response => response.json())
  .then(result => {
      if (result.status === 'success') {
          alert('تم الحفظ بنجاح في جوجل شيتس!');
      } else {
          alert('حدث خطأ في الحفظ.');
      }
  })
  .catch(error => {
      console.error('Error:', error);
      alert('حدث خطأ في الاتصال بالخادم.');
  });
});

// الكود المصحح لزر البحث
byId('btnSearch').addEventListener('click', ()=>{
  const clientCode = byId('clientCode').value.trim();
  if(!clientCode) {
    alert('من فضلك أدخل كود العميل أولاً.');
    return;
  }
  
  // URL الخاص بدالة البحث (doGet) في Google Apps Script
  const url = `https://script.google.com/macros/s/AKfycbzH-RZg4LBcKwpGwA0vKqb38nacd2Cq5zfVii56oH9Ed4kDsL9CspODlyJWrJIdZK5FcQ/exec?clientCode=${clientCode}`;

  fetch(url)
    .then(response => response.json())
    .then(clientData => {
      if (clientData && clientData.status !== 'error') {
        // ملء الحقول الرئيسية
        byId('clientName').value = clientData['اسم العميل'] || '';
        byId('projectName').value = clientData['اسم المشروع'] || '';
        byId('internalMaterial').value = clientData['الخامة الداخلية'] || '';
        byId('externalMaterial').value = clientData['الخامة الخارجية'] || '';

        // تفريغ وإعادة ملء جداول المراحل
        STAGES.forEach(stage => {
          const tbl = byId(stageId(stage.id));
          if (tbl) {
            tbl.querySelector('tbody').innerHTML = '';
          }
        });
        
        if (clientData['بيانات المراحل'] && clientData['بيانات المراحل'].length > 0) {
          clientData['بيانات المراحل'].forEach(stageRow => {
            const stageTable = byId(stageId(stageRow.stage));
            if (stageTable) {
              const basicStage = STAGES.find(s => s.id === stageRow.stage).basic;
              addRowToTable(stageTable, basicStage, stageRow);
            }
          });
        }
        
        // إعادة ملء قسم الخامات الإضافية
        const extraMaterialsContainer = byId('extraMaterialsContainer');
        extraMaterialsContainer.innerHTML = '';
        if (clientData['خامات إضافية']) {
          const extraMaterials = clientData['خامات إضافية'].split(' | ');
          extraMaterials.forEach(mat => {
            const parts = mat.split(',').map(p => p.trim());
            const div = create('div'); div.className = 'material-wrap';
            parts.forEach(p => {
              if (p) div.appendChild(create('span', p));
            });
            const delBtn = create('button', '-'); delBtn.className='del-material'; delBtn.onclick = ()=> div.remove();
            div.appendChild(delBtn);
            extraMaterialsContainer.appendChild(div);
          });
        }
        
        alert('تم استرجاع بيانات العميل بنجاح.');
      } else {
        alert('لم يتم العثور على بيانات لهذا العميل.');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('حدث خطأ في الاتصال بالخادم.');
    });
});
// تحديث Dropdown للأكواد المحفوظة
function updateSavedCodesDropdown(){
  const dropdown = byId('savedCodesDropdown');
  dropdown.innerHTML = '<option value="">اختر كود محفوظ</option>';
  Object.keys(clientsData).forEach(code=>{
    const opt = create('option');
    opt.value = code;
    const label = clientsData[code].clientName ? `${code} - ${clientsData[code].clientName}` : code;
    const last = clientsData[code].lastUpdate ? ` (آخر تحديث: ${clientsData[code].lastUpdate})` : '';
    opt.textContent = label + last;
    dropdown.appendChild(opt);
  });
}

// استرجاع بيانات العميل بالكامل
function recallClientData(code){
  const client = clientsData[code];
  if(!client) return false;

  byId('clientCode').value = code;
  byId('clientName').value = client.clientName || '';
  byId('projectName').value = client.projectName || '';
  byId('internalMaterial').value = client.internalMaterial || '';
  byId('externalMaterial').value = client.externalMaterial || '';

  // إعادة بناء المواد الإضافية
  byId('extraMaterialsContainer').innerHTML = '';
  if(Array.isArray(client.extraMaterials)){
    client.extraMaterials.forEach(mat=>{
      const div = create('div'); div.className = 'material-wrap';
      if(mat.internal) div.appendChild(create('span',`الخامة الداخلية: ${mat.internal}`));
      if(mat.external) div.appendChild(create('span',`الخامة الخارجية: ${mat.external}`));
      const delBtn = create('button','-'); delBtn.className='del-material'; delBtn.onclick = ()=> div.remove();
      div.appendChild(delBtn);
      byId('extraMaterialsContainer').appendChild(div);
    });
  } else {
    // إذا لم تكن مصفوفة، حاول وضع الحقول الأساسية
    if(client.internalMaterial || client.externalMaterial){
      const div = create('div'); div.className = 'material-wrap';
      if(client.internalMaterial) div.appendChild(create('span',`الخامة الداخلية: ${client.internalMaterial}`));
      if(client.externalMaterial) div.appendChild(create('span',`الخامة الخارجية: ${client.externalMaterial}`));
      const delBtn = create('button','-'); delBtn.className='del-material'; delBtn.onclick = ()=> div.remove();
      div.appendChild(delBtn);
      byId('extraMaterialsContainer').appendChild(div);
    }
  }

  // تفريغ كل الجداول وإعادتها بحسب البيانات
  STAGES.forEach(stage=>{
    const tbl = byId(stageId(stage.id));
    if(!tbl) return;
    tbl.querySelector('tbody').innerHTML = '';
    const stageRows = (client.stages || []).filter(r => r.stage === stage.id);
    if(stageRows.length){
      stageRows.forEach(rowData => addRowToTable(tbl, stage.basic, rowData));
    } else {
      // لو مفيش صفوف مخزنة، ضيف صف واحد فارغ
      addRowToTable(tbl, stage.basic);
    }
  });

  // تعديل هنا لعرض تواريخ التخزين/التوريد أيضاً
  let recallText = `تم استرجاع البيانات ✅${client.lastUpdate ? ' (آخر تحديث: ' + client.lastUpdate + ')' : ''}`;
  if(client.storageDate) recallText += ` | 📦 تاريخ التخزين: ${client.storageDate}`;
  if(client.supplyDate)  recallText += ` | 🚚 تاريخ التوريد: ${client.supplyDate}`;

  byId('recallMsg').textContent = recallText;
  byId('recallMsg').style.display = 'inline';
  updateTechSelects();
  return true;
}

// زر البحث 🔎
byId('btnSearch').addEventListener('click', ()=>{
  const code = byId('clientCode').value.trim();
  if(!code) return alert('أدخل كود العميل للبحث');
  if(!recallClientData(code)){
    byId('recallMsg').textContent = 'لم يتم العثور على بيانات ❌';
    byId('recallMsg').style.display = 'inline';
  }
});
// استرجاع من DropDown (محسّن: يدعم change + زر الاسترجاع)
const savedDropdown = byId('savedCodesDropdown');

// عند الضغط على زر "استرجاع"
byId('btnLoadSaved').addEventListener('click', ()=>{
  const code = savedDropdown.value;
  if(!code) return alert('اختر كود محفوظ أولاً');
  byId('clientCode').value = code;
  byId('btnSearch').click();
  // اختياري: ارجع الافتراضي في القائمة بعد التحميل
  // savedDropdown.selectedIndex = 0;
});

// عند تغير الاختيار في الـ dropdown — يحمّل تلقائياً
savedDropdown.addEventListener('change', ()=>{
  const code = savedDropdown.value;
  if(!code) {
    // لو اخترت الخيار الافتراضي (فارغ) نعمل لا شيء
    return;
  }
  byId('clientCode').value = code;
  byId('btnSearch').click();
});

// تصدير JSON (كل العملاء المخزنين)
byId('btnExportJSON').addEventListener('click', ()=>{
  const dataStr = JSON.stringify(clientsData, null, 2);
  const blob = new Blob([dataStr], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = create('a'); a.href = url; a.download = 'motabaa_clients.json'; a.click();
  URL.revokeObjectURL(url);
});

// تصدير PDF (لكل عميل)
byId('btnExportPDF').addEventListener('click', ()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  let first = true;
  Object.keys(clientsData).forEach(code=>{
    const client = clientsData[code];
    if(!first) doc.addPage(); first = false;
    doc.setFontSize(12);
    doc.text(`كود العميل: ${code}`,10,20);
    doc.text(`اسم العميل: ${client.clientName || ''}`,10,28);
    doc.text(`المشروع: ${client.projectName || ''}`,10,36);
    doc.text(`الخامة الداخلية: ${client.internalMaterial || ''}`,10,44);
    doc.text(`الخامة الخارجية: ${client.externalMaterial || ''}`,10,52);
    (client.stages || []).forEach((stageRow, idx) => {
      const header = ['المرحلة','نوع البند','اسم البند','الفني','بدء','انتهاء','مدة','وحدات','ملاحظات','الحالة'];
      const row = [
        stageRow.stage || '',
        stageRow.type || '',
        stageRow.name || '',
        stageRow.tech || '',
        stageRow.start || '',
        stageRow.end || '',
        stageRow.duration || '',
        stageRow.units || '',
        (stageRow.notes || '').replace(/\n/g,' '),
        stageRow.status || ''
      ];
      doc.autoTable({ head:[header], body:[row], startY: doc.lastAutoTable ? doc.lastAutoTable.finalY + 8 : 60 });
    });
  });
  doc.save('motabaa_clients.pdf');
});

// تهيئة عند البداية
renderStageTables();
updateTechSelects();
updateSavedCodesDropdown();
</script>
</body>
</html>
